name,sql
SiiceaInputTest,"CREATE VIEW SiiceaInputTest AS
 SELECT 
COUNT(*) AS ""Nombre de lignes""
, COUNT(DISTINCT ""Identifiant de la mission"") AS ""Nombre distint d'id de missions""
, SUM(IIF(LENGTH(""Code FINESS"")=8,1,0)) AS ""Longueur KO FINESS""
, SUM(IIF(LENGTH(""Code FINESS"")=9,1,0)) AS ""Longueur ok FINESS""
, COUNT(DISTINCT(LENGTH(""Code FINESS""))) AS ""Nombre de longueurs différentes de FINESS""
, MIN(""Date réelle """"Visite"""""") AS ""Date réelle de visite la + ancienne""
, MAX(""Date réelle """"Visite"""""") AS ""Date réelle de visite la + récente""
, MIN(SUBSTR(""Date réelle """"Visite"""""",1,4)) AS ""Année min""
, MIN(SUBSTR(""Date réelle """"Visite"""""",6,2)) AS ""Mois min""
, MAX(SUBSTR(""Date réelle """"Visite"""""",1,4)) AS ""Année max""
, MAX(SUBSTR(""Date réelle """"Visite"""""",6,2)) AS ""Mois max""
FROM sa_siicea_missions_20240930"
HeliosSiiceaMissionsTest,"CREATE VIEW HeliosSiiceaMissionsTest AS
 SELECT 
COUNT(*) AS ""Nombre de lignes""
, COUNT(DISTINCT ""Identifiant de la mission"") AS ""Nombre distint d'id de missions""
, SUM(IIF(LENGTH(CD_FINESS)=8,1,0)) AS ""Longueur KO FINESS""
, SUM(IIF(LENGTH(CD_FINESS)=9,1,0)) AS ""Longueur ok FINESS""
, COUNT(DISTINCT(LENGTH(CD_FINESS))) AS ""Nombre de longueurs différentes de FINESS""
, MIN(""Date réelle """"Visite"""""") AS ""Date réelle de visite la + ancienne""
, MAX(""Date réelle """"Visite"""""") AS ""Date réelle de visite la + récente""
, MIN(SUBSTR(""Date réelle """"Visite"""""",1,4)) AS ""Année min""
, MIN(SUBSTR(""Date réelle """"Visite"""""",6,2)) AS ""Mois min""
, MAX(SUBSTR(""Date réelle """"Visite"""""",1,4)) AS ""Année max""
, MAX(SUBSTR(""Date réelle """"Visite"""""",6,2)) AS ""Mois max""
FROM HeliosSiiceaMissions"
SirecInputTest,"CREATE VIEW SirecInputTest AS 
SELECT 
COUNT(*) AS ""Nombre de lignes""
, COUNT(DISTINCT ""Numéro de la réclamation"") AS ""Nombre distinct de réclamations""
, SUM(IIF(LENGTH(""N° FINESS/RPPS"")=8,1,0)) AS ""Longueur KO FINESS""
, SUM(IIF(LENGTH(""N° FINESS/RPPS"")=9,1,0)) AS ""Longueur ok FINESS""
, MIN(""Date de réception à l’ARS"") AS ""Date réelle de visite la + ancienne""
, MAX(""Date de réception à l’ARS"") AS ""Date réelle de visite la + récente""
, MIN(SUBSTR(""Date de réception à l’ARS"",1,4)) AS ""Année min""
, MIN(SUBSTR(""Date de réception à l’ARS"",6,2)) AS ""Mois min""
, MAX(SUBSTR(""Date de réception à l’ARS"",1,4)) AS ""Année max""
, MAX(SUBSTR(""Date de réception à l’ARS"",6,2)) AS ""Mois max""
FROM sa_sirec_20241014"
DGCSQuery,"CREATE VIEW DGCSQuery AS
WITH 
Finess AS (SELECT 
	finess
	, ""ref_geo_old"".REG_CD 
	, ""ref_geo_old"".REG_LB 
	, ""ref_geo_old"".DEP_CD 
	, ""ref_geo_old"".DEP_LB 
	, com_code 
	, ""ref_geo_old"".COM_LB 
	, etat
	, categ_code 
	, categ_lib 
FROM 
	sa_t_finess_20241231  
LEFT JOIN 
	""ref_geo_old"" 
		ON (IIF(LENGTH(sa_t_finess_20241231.com_code)=4
		, '0' || sa_t_finess_20241231.com_code
		, sa_t_finess_20241231.com_code))
		= ""ref_geo_old"".COM_CD 
WHERE 
	categ_code IN (448.0
								, 402.0
								, 396.0
								, 395.0
								, 370.0
								, 437.0
								, 255.0
								, 246.0
								, 198.0
								, 249.0
								, 238.0
								, 390.0
								, 188.0
								, 377.0
								, 192.0
								, 183.0
								, 186.0
								, 195.0
								, 194.0
								, 196.0
								, 379.0
								, 445.0
								, 221.0
								, 190.0
								, 189.0
								, 182.0
                        )
)
, ModeActivite AS (
SELECT 
	IIF(LENGTH(numero_finess_et)=8,'0'||numero_finess_et,numero_finess_et) AS numero_finess_et 
	, CASE 
		WHEN libelle_du_code_dactivite = 'Accueil temporaire avec hébergement' 						THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Accueil de Jour' 											THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Hébergement Complet Internat' 							THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Hébergement de Nuit Eclaté' 								THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Internat de Semaine' 										THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Placement Famille d''Accueil' 								THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Tous modes d''accueil avec hébergement' 					THEN 'Internat'
		WHEN libelle_du_code_dactivite = 'Accueil temporaire (avec et sans hébergement)' 			THEN 'TMA'
		WHEN libelle_du_code_dactivite = 'Tous modes d''accueil (avec et sans hébergement)' 			THEN 'TMA'
		WHEN libelle_du_code_dactivite = 'Tous modes d''accueil et d''accompagnement' 				THEN 'TMA'
		WHEN libelle_du_code_dactivite = 'Accueil de jour et accompagnement en milieu ordinaire' 	THEN 'Externat'
		WHEN libelle_du_code_dactivite = 'Accueil temporaire de jour' 								THEN 'Externat'
		WHEN libelle_du_code_dactivite = 'Accueil de Jour' 											THEN 'Externat'
		WHEN libelle_du_code_dactivite = 'Externat' 												THEN 'Externat'
		WHEN libelle_du_code_dactivite = 'Semi-Internat' 											THEN 'Externat'
		WHEN libelle_du_code_dactivite = 'Consultation Soins Externes' 								THEN 'MO'
		WHEN libelle_du_code_dactivite = 'Prestation en milieu ordinaire' 							THEN 'MO'
		WHEN libelle_du_code_dactivite = 'Traitement et Cure Ambulatoire' 							THEN 'MO'
		WHEN libelle_du_code_dactivite = 'Type d''activité indifferencié' 							THEN 'MO'
		ELSE 'Autre'
	END AS MODE_ACTIVITE
	, SUM(capacite_autorisee_totale) AS capacite_autorisee_totale
FROM 
	sa_finess_equipement_esms_20241112
WHERE 
	indicateur_de_suppression_de_lautorisation != 'O'
GROUP BY 
	numero_finess_et)
, AggActivité AS (SELECT 
	numero_finess_et 
	, CASE 
		WHEN MODE_ACTIVITE = 'Internat' 	THEN SUM(capacite_autorisee_totale)
	END AS Internat
	, CASE 
		WHEN MODE_ACTIVITE = 'TMA' 			THEN SUM(capacite_autorisee_totale)
	END AS TMA
	, CASE 
		WHEN MODE_ACTIVITE = 'Externat' 	THEN SUM(capacite_autorisee_totale)
	END AS Externat
	, CASE 
		WHEN MODE_ACTIVITE = 'MO' 			THEN SUM(capacite_autorisee_totale)
	END AS MO
	, CASE 
		WHEN MODE_ACTIVITE = 'Autre' 		THEN SUM(capacite_autorisee_totale)
	END AS Autre
FROM 
	ModeActivite
GROUP BY
	numero_finess_et) 
SELECT
	*
FROM 
	Finess
LEFT JOIN 
	ModeActivite ON Finess.finess = ModeActivite.numero_finess_et"
CertDCInsern,"CREATE VIEW CertDCInsern AS 
SELECT 
rowid AS ""index""
, Annee
, Mois
, Jour
, departement_code
, commune_code
, et_finess
, Lieu_de_deces
, ""Source""
, 1 AS deces_nb
FROM sa_insern_20250114"
CertDCTFiness,"CREATE VIEW CertDCTFiness AS
SELECT 
 Column1
, source
, date_maj
, finess
, finess8
, etat
, date_extract_finess
, rs
, type
, ej_finess
, ej_rs
, et_finess
, et_rs
, siren
, siret
, date_autorisation
, date_ouverture
, date_maj_finess
, adresse_num_voie
, adresse_comp_voie
, adresse_type_voie
, adresse_nom_voie
, adresse_lieuditbp
, adresse_code_postal
, adresse_lib_routage
, telephone
, telecopie
, IIF(LENGTH(com_code)=4
		,'0'||com_code
		,com_code) AS com_code
, statut_jur_code
, statut_jur_lib
, statut_jur_etat
, statut_jur_niv3_code
, statut_jur_niv3_lib
, statut_jur_niv2_code
, statut_jur_niv2_lib
, statut_jur_niv1_code
, statut_jur_niv1_lib
, CAST(categ_code AS INTEGER) AS categ_code
, categ_lib
, categ_lib_court
, categ_etat
, categ_niv3_code
, categ_niv3_lib
, categ_niv2_code
, categ_niv2_lib
, categ_niv1_code
, categ_niv1_lib
, categ_domaine
, esms
, esms_capaTot_inst
, esms_capaInternat_inst
, esms_esh
, esms_ash
, esms_pa
, san
, san_med
, san_chir
, san_obs
, san_psy
, san_sld
, san_urg
--, san_rea
, san_dialyse
, san_cancer
--, san_ssr
, nb_scanners
, nb_irm
, gestion_ars
, gestion_dreets
, gestion_drihl
, version_nomenclature
, tutelle
, mft_code
, mft_lib
, sph_code
, sph_lib
, geoloc_source
, geoloc_precision
, geoloc_legal_x
, geoloc_legal_y
, geoloc_legal_projection
, geoloc_3857_x
, geoloc_3857_y
, geoloc_4326_long
, geoloc_4326_lat
FROM sa_t_finess_20250113"
MatriceSirec,"CREATE VIEW MatriceSirec AS 
SELECT 
""Numéro de la réclamation""
, ""Ancien numéro de la réclamation""
, ""Numéro Démat Social""
, ""Service gestionnaire""
, ""Statut de la réclamation""
, ""Services en lecture""
, Signalement
, ""Date de la demande du requérant""
, ""Date de réception à l’ARS""
, ""Service de premier niveau""
, ""Date de réception au service de premier niveau""
, Description
, ""Date de création de la réclamation""
, ""Domaine fonctionnel""
, ""Mode de réception""
, ""Prioritaire : Oui/Non""
, ""Précisions sur le caractère prioritaire""
, ""Département de la réclamation""
, ""Destinataire(s) de la réclamation""
, ""Destinataire primaire""
, ""Destinataire secondaire""
, ""Saisine du procureur par requérant""
, ""Institutions de provenance""
, ""Date de réception à l'institution de provenance""
, reponse_attendue
, ""Courrier signalé : Oui/Non""
, ""Le requérant est""
, ""Le requérant est anonyme""
, ""Le requérant souhaite garder l'anonymat""
, ""Statut du requérant""
, ""Plus de 2 réclamations déposées""
, ""Usager (victime) non identifiée""
, ""Sans mis en cause""
, ""N° FINESS/RPPS""
, Autre_Type
, ""Nom structure""
, Adresse
, ""Code postal""
, Ville
, ""Service pour les établissements sanitaires""
, ""Observations du mis en cause""
, CASE 
	WHEN ""Motifs IGAS sortie"" != '' THEN ""Motifs IGAS sortie""
	ELSE ""Motifs IGAS entrée"" 
END AS ""Motifs IGAS""
, ""Motifs IGAS entrée"" 
, ""Motifs IGAS sortie"" 
, ""Niveau de compétence de traitement de la réclamation""
, ""Institution(s) partenaire(s)""
, ""Précisions sur le niveau de compétence de traitement de la réclamation""
, ""Envoi d'un accusé réception""
, ""Date d'envoi de l'AR""
, ""Précisions sur le non envoi de l'AR""
, ""Date de transfert à l'institution compétente""
, ""Date de prise en charge par le service gestionnaire""
, ""Type de traitement""
, ""Précisions sur le type de traitement""
, ""Réclamation en lien avec un ou plusieurs signalements""
, ""Numéro(s) de signalement(s) associé(s)""
, ""Date d'examen en commission""
, ""Type d'action""
, ""Mesures prises par le mis en cause""
, ""Mesures à l'initiative de""
, ""Réponse au requérant par l'ARS""
, ""Date de réponse au requérant""
, ""Précisions sur la réponse au requérant""
, ""Date de réponse  à l'institution de provenance""
, ""Motif de clôture""
, Commentaire
, ""Date de clôture""
, ""Siège ARS""
, ""Motifs déclarés""
FROM sa_sirec_20250114
WHERE 1=1
AND (LENGTH(""N° FINESS/RPPS"") = 9 OR LENGTH(""N° FINESS/RPPS"") = 8)
AND ""Date de réception à l’ARS"" < '2024-12-31'"
HeliosSiiceaMissions,"CREATE VIEW HeliosSiiceaMissions AS 
SELECT 
*
, CASE 
	WHEN LENGTH(""Code FINESS"")=8 THEN '0' || ""Code FINESS""
	ELSE ""Code FINESS""
END AS CD_FINESS
FROM sa_siicea_missions_real_20250120
-- filtre des thèmes IGAS (on ne conserve que ce qui concerne les soins)
--WHERE ""Code thème IGAS"" IN (
WHERE ""Code IGAS"" IN (
'MS634D13'
, 'MS634D13'
, 'MS634N1'
, 'MS634E1'
, 'MS634D12'
, 'MS634R1'
, 'MS634D11'
, 'MS634D15'
, 'MS634C10'
, 'MS634C10'
)
-- filtre sur les types de mission (on ne conserve que les types inspeciton et contrôle)
AND ""Type de mission"" NOT IN (
'Audit'
, 'Audit franco-wallon'
, 'Evaluation'
, 'Visites de conformité'
, 'Enquête administrative'
)
-- filtre sur le statut (on ne conserve que les statuts qui correspondent au réalisé)
--AND ""Statut de la mission"" IN (
AND ""Statut mission"" IN (
'Clôturé'
, 'Maintenu'
)
-- filtre sur la date pour ne retenir que les missions dont la date réelle de visite est comprise entre le 01/01 de N-3 et le dernier jour du dernier trimestre de N
-- date de début 
AND (
	CAST (
		SUBSTR ( -- annee
			""Date réelle """"Visite"""""" 
			, 1
			, 4) 
		|| SUBSTR ( -- mois
			""Date réelle """"Visite"""""" 
			, 6
			, 2) 
		|| SUBSTR ( -- jour
			""Date réelle """"Visite"""""" 
			, 9
			, 4) 
		AS INTEGER) 
	) >= 20220101
-- date de fin
AND (
	CAST (
		SUBSTR ( -- annee
			""Date réelle """"Visite"""""" 
			, 1
			, 4) 
		|| SUBSTR ( -- mois
			""Date réelle """"Visite"""""" 
			, 6
			, 2) 
		|| SUBSTR ( -- jour
			""Date réelle """"Visite"""""" 
			, 9
			, 4) 
		AS INTEGER) 
	) <= 20241231"
HeliosSiiceaDecisions,CREATE VIEW HeliosSiiceaDecisions AS SELECT * FROM sa_siicea_decisions_20250120
HeliosSirec,"CREATE VIEW HeliosSirec AS 
SELECT 
""Numéro de la réclamation""
, ""Ancien numéro de la réclamation""
, ""Numéro Démat Social""
, ""Service gestionnaire""
, ""Statut de la réclamation""
, ""Services en lecture""
, Signalement
, ""Date de la demande du requérant""
, ""Date de réception à l’ARS""
, ""Service de premier niveau""
, ""Date de réception au service de premier niveau""
, Description
, ""Date de création de la réclamation""
, ""Domaine fonctionnel""
, ""Mode de réception""
, ""Prioritaire : Oui/Non""
, ""Précisions sur le caractère prioritaire""
, ""Département de la réclamation""
, ""Destinataire(s) de la réclamation""
, ""Destinataire primaire""
, ""Destinataire secondaire""
, ""Saisine du procureur par requérant""
, ""Institutions de provenance""
, ""Date de réception à l'institution de provenance""
, reponse_attendue
, ""Courrier signalé : Oui/Non""
, ""Le requérant est""
, ""Le requérant est anonyme""
, ""Le requérant souhaite garder l'anonymat""
, ""Statut du requérant""
, ""Plus de 2 réclamations déposées""
, ""Usager (victime) non identifiée""
, ""Sans mis en cause""
, ""N° FINESS/RPPS""
, Autre_Type
, ""Nom structure""
, Adresse
, ""Code postal""
, Ville
, ""Service pour les établissements sanitaires""
, ""Observations du mis en cause""
, CASE 
	WHEN ""Motifs IGAS sortie"" != '' THEN ""Motifs IGAS sortie""
	ELSE ""Motifs IGAS entrée"" 
END AS ""Motifs IGAS""
, ""Motifs IGAS entrée"" 
, ""Motifs IGAS sortie"" 
, ""Niveau de compétence de traitement de la réclamation""
, ""Institution(s) partenaire(s)""
, ""Précisions sur le niveau de compétence de traitement de la réclamation""
, ""Envoi d'un accusé réception""
, ""Date d'envoi de l'AR""
, ""Précisions sur le non envoi de l'AR""
, ""Date de transfert à l'institution compétente""
, ""Date de prise en charge par le service gestionnaire""
, ""Type de traitement""
, ""Précisions sur le type de traitement""
, ""Réclamation en lien avec un ou plusieurs signalements""
, ""Numéro(s) de signalement(s) associé(s)""
, ""Date d'examen en commission""
, ""Type d'action""
, ""Mesures prises par le mis en cause""
, ""Mesures à l'initiative de""
, ""Réponse au requérant par l'ARS""
, ""Date de réponse au requérant""
, ""Précisions sur la réponse au requérant""
, ""Date de réponse  à l'institution de provenance""
, ""Motif de clôture""
, Commentaire
, ""Date de clôture""
, ""Siège ARS""
, ""Motifs déclarés""
FROM sa_sirec_20250114
WHERE ""Date de réception à l’ARS"" >= '2022-01-01' 
AND ""Date de réception à l’ARS"" <= '2024-12-31'"
HeliosSivss,"CREATE VIEW HeliosSivss AS 
SELECT 
STRUCTURE_INTITULE
, NUMERO_SIVSS
, SUBSTR(DATE_RECEPTION, 7, 4) || ""-"" || SUBSTR(DATE_RECEPTION, 4, 2) || ""-"" || SUBSTR(DATE_RECEPTION, 1, 2) AS DATE_RECEPTION
, FAMILLE_PRINCIPALE
, NATURE_PRINCIPALE
, AUTRE_SIGNAL_LIBELLE
, FAMILLE_SECONDAIRE
, NATURE_SECONDAIRE
, AUTRE_SIGNAL_SECONDAIRE_LIBELLE
, EST_EIGS
, CONSEQUENCES_PERSONNE_EXPOSEE
, RECLAMATION
, DECLARANT_EST_ANONYME
, DECLARANT_QUALITE_FONCTION
, DECLARANT_CATEGORIE
, DECLARANT_ORGANISME_TYPE
, DECLARANT_ETABLISSEMENT_TYPE
, DECLARANT_ORGANISME_NUMERO_FINESS
, DECLARANT_ORGANISME_NOM
, DECLARANT_ORGANISME_REGION
, DECLARANT_ORGANISME_DEPARTEMENT
, DECLARANT_ORGANISME_CODE_POSTAL
, DECLARANT_ORGANISME_COMMUNE
, DECLARANT_ORGANISME_CODE_INSEE
, SURVENUE_CAS_COLLECTIVITE
, SCC_ORGANISME_TYPE
, SCC_ETABLISSEMENT_TYPE
, SCC_ORGANISME_NOM
, SCC_ORGANISME_FINESS
, SCC_ORGANISME_REGION
, SCC_ORGANISME_DEPARTEMENT
, SCC_ORGANISME_CODE_POSTAL
, SCC_ORGANISME_COMMUNE
, SCC_ORGANISME_CODE_INSEE
, ETAT
, SUPPORT_SIGNALEMENT
, (SUBSTR(DATE_CLOTURE, 7, 4)) || ""-"" || (SUBSTR(DATE_CLOTURE, 4, 2))  || ""-"" || (SUBSTR(DATE_CLOTURE, 1, 2)) AS DATE_CLOTURE
, MOTIF_CLOTURE
FROM sa_sivss_20250107
WHERE (SUBSTR(DATE_CLOTURE, 7, 4) || SUBSTR(DATE_CLOTURE, 4, 2)) <= '202412'"
MatriceSiiceaMissionsReal,"CREATE VIEW MatriceSiiceaMissionsReal AS
SELECT 
*
FROM sa_siicea_missions_real_20250120
WHERE 1=1
-- filtre sur la période
AND (""Date réelle """"Visite"""""" >= '2022-01-01' AND ""Date réelle """"Visite"""""" <= '2024-12-31')
-- filtre sur le statut réalisé 
AND ""Statut de la mission"" IN ('Clôturé'
	, 'Maintenu')
-- filtre sur le secteur ESMS
AND ""Secteur d'intervention"" = 'Médico-social'
-- filtre sur le type d'établissement
--AND ""Type de cible"" = ""Etablissements et Services pour Personnes Agées""
-- filtre des thèmes IGAS (on ne conserve que ce qui concerne les soins)
AND ""Code thème IGAS"" IN (
'MS634D13'
, 'MS634D13'
, 'MS634N1'
, 'MS634E1'
, 'MS634D12'
, 'MS634R1'
, 'MS634D11'
, 'MS634D15'
, 'MS634C10'
, 'MS634C10'
)
-- filtre sur les types de mission (on ne conserve que les types inspeciton et contrôle)
AND ""Type de mission"" NOT IN (
'Audit'
, 'Audit franco-wallon'
, 'Evaluation'
, 'Visites de conformité'
, 'Enquête administrative'
)"
MatriceSiiceaMissionsProg,"CREATE VIEW MatriceSiiceaMissionsProg AS
SELECT 
*
FROM sa_siicea_missions_prog_20250120
WHERE 1=1
-- filtre sur la période
AND (""Date réelle """"Visite"""""" = '' AND ""Date provisoire """"Visite"""""" > '2024-09-30')
-- filtre sur le statut réalisé 
AND ""Statut de la mission"" NOT IN ('Clôturé'
	, 'Abandonné')
-- filtre sur le secteur ESMS
AND ""Secteur d'intervention"" = 'Médico-social'
-- filtre sur le type d'établissement
--AND ""Type de cible"" = ""Etablissements et Services pour Personnes Agées""
-- filtre des thèmes IGAS (on ne conserve que ce qui concerne les soins)
AND ""Code thème IGAS"" IN (
'MS634D13'
, 'MS634D13'
, 'MS634N1'
, 'MS634E1'
, 'MS634D12'
, 'MS634R1'
, 'MS634D11'
, 'MS634D15'
, 'MS634C10'
, 'MS634C10'
)
-- filtre sur les types de mission (on ne conserve que les types inspeciton et contrôle)
AND ""Type de mission"" NOT IN (
'Audit'
, 'Audit franco-wallon'
, 'Evaluation'
, 'Visites de conformité'
, 'Enquête administrative'
)"
TdBICFiness_500,"CREATE VIEW TdBICFiness_500 AS

--SELECT
--""Column1""
--, ""source""
--, ""date_maj""
--, ""finess""
--, ""finess8""
--, ""etat""
--, ""date_extract_finess""
--, ""rs""
--, ""type""
--, ""ej_finess""
--, ""ej_rs""
--, ""et_finess""
--, ""et_rs""
--, ""siren""
--, ""siret""
--, ""date_autorisation""
--, ""date_ouverture""
--, ""date_maj_finess""
--, ""adresse_num_voie""
--, ""adresse_comp_voie""
--, ""adresse_type_voie""
--, ""adresse_nom_voie""
--, ""adresse_lieuditbp""
--, ""adresse_code_postal""
--, ""adresse_lib_routage""
--, ""telephone""
--, ""telecopie""
--, IIF(LENGTH(""com_code"")=4,'0'||""com_code"",""com_code"") AS ""com_code""
--, ""statut_jur_code""
--, ""statut_jur_lib""
--, ""statut_jur_etat""
--, ""statut_jur_niv3_code""
--, ""statut_jur_niv3_lib""
--, ""statut_jur_niv2_code""
--, ""statut_jur_niv2_lib""
--, ""statut_jur_niv1_code""
--, ""statut_jur_niv1_lib""
--, ""categ_code""
--, ""categ_lib""
--, ""categ_lib_court""
--, ""categ_etat""
--, ""categ_niv3_code""
--, ""categ_niv3_lib""
--, ""categ_niv2_code""
--, ""categ_niv2_lib""
--, ""categ_niv1_code""
--, ""categ_niv1_lib""
--, ""categ_domaine""
--, ""esms""
--, ""esms_capaTot_inst""
--, ""esms_capaInternat_inst""
--, ""esms_esh""
--, ""esms_ash""
--, ""esms_pa""
--, ""san""
--, ""san_med""
--, ""san_chir""
--, ""san_obs""
--, ""san_psy""
--, ""san_sld""
--, ""san_urg""
--, ""san_rea""
--, ""san_dialyse""
--, ""san_cancer""
--, ""san_ssr""
--, ""nb_scanners""
--, ""nb_irm""
--, ""gestion_ars""
--, ""gestion_dreets""
--, ""gestion_drihl""
--, ""version_nomenclature""
--, ""tutelle""
--, ""mft_code""
--, ""mft_lib""
--, ""sph_code""
--, ""sph_lib""
--, ""geoloc_source""
--, ""geoloc_precision""
--, ""geoloc_legal_x""
--, ""geoloc_legal_y""
--, ""geoloc_legal_projection""
--, ""geoloc_3857_x""
--, ""geoloc_3857_y""
--, ""geoloc_4326_long""
--, ""geoloc_4326_lat""
--
--FROM sa_t_finess_20240912 x
--where categ_code = 500.0
--and etat = 'ACTUEL'
SELECT
finess
, rs
, com_code 
, statut_jur_niv2_code
, statut_jur_niv2_lib 
, etat
FROM sa_t_finess_20250203
WHERE categ_code = 500 
AND etat = ""ACTUEL"""
RefRegions,"CREATE VIEW RefRegions AS
SELECT
	vr.REG AS ""REG""
	, vr.NCC AS ""NCC""
	, vr.LIBELLE AS ""LIBELLE""
FROM ""v_region_20250207"" vr
UNION
SELECT
	vc.COMER AS ""REG""
	, vc.NCC AS ""NCC""
	, vc.LIBELLE AS ""LIBELLE""
FROM ""v_comer_20250207"" vc"
RefDepartements,"CREATE VIEW RefDepartements AS
SELECT
	vd.DEP AS ""DEP""
	, vd.REG AS ""REG""
	, vd.NCC AS ""NCC""
	, vd.LIBELLE AS ""LIBELLE""
FROM v_departement_20250207 vd
UNION
-- DROM
SELECT
	vc.COMER AS ""DEP""
	, vc.COMER AS ""REG""
	, vc.NCC AS ""NCC""
	, vc.LIBELLE AS ""LIBELLE""
FROM v_comer_20250207 vc"
RefCommunes,"CREATE VIEW RefCommunes AS
WITH 
ALL_COM AS (
	SELECT 
	--COM actuelles
		vc.COM AS ""COM""
		, vc.REG AS ""REG""
		, vc.DEP AS ""DEP""
		, vc.NCC AS ""NCC"" 
		, vc.LIBELLE AS ""LIBELLE""
	FROM 
		v_commune_20250207 vc
	WHERE 
		REG != """"
	UNION 
	--DROM
	SELECT
		vcc.COM_COMER AS ""COM""
		, vcc.COMER AS ""REG""
		, vcc.COMER AS ""DEP""
		, vcc.NCC AS ""NCC"" 
		, vcc.LIBELLE AS ""LIBELLE""
	FROM 
		v_commune_comer_20250207 vcc
	UNION
	--historique
	SELECT 
		vcd.COM AS ""COM""
		, RefDepartements.REG AS ""REG""
		, CASE 
			WHEN vcd.COM >= 97000 THEN SUBSTR(vcd.COM, 1, 3)
			ELSE SUBSTR(vcd.COM, 1, 2)
		END AS ""DEP""
		, vcd.NCC AS ""NCC"" 
		, vcd.LIBELLE AS ""LIBELLE""
	FROM 
		v_commune_depuis_20250207 vcd
	LEFT JOIN 
		RefDepartements ON (
			CASE 
				WHEN vcd.COM >= 97000 THEN SUBSTR(vcd.COM, 1, 3)
				ELSE SUBSTR(vcd.COM, 1, 2)
			END) 
		= RefDepartements.DEP)
-- on enlève les doublons
SELECT
	*
FROM
	ALL_COM
GROUP BY
	1"
RefGeo,"CREATE VIEW RefGeo AS 
SELECT
RefCommunes.COM AS COM_CD
, RefCommunes.LIBELLE AS COM_LB
, RefDepartements.DEP AS DEP_CD
, RefDepartements.LIBELLE AS DEP_LB
, RefRegions.REG AS REG_CD
, RefRegions.LIBELLE AS REG_LB
FROM RefCommunes
LEFT JOIN RefDepartements ON RefCommunes.DEP = RefDepartements.DEP 
LEFT JOIN RefRegions ON RefDepartements.REG = RefRegions.REG"
TdBICSiiceaMissionsprog,"CREATE VIEW TdBICSiiceaMissionsprog AS 

SELECT 
""Identifiant de la mission""
--, ""Mission proposée par""
--, ""Secteur d'intervention""
, ""Code thème IGAS""
, ""Thème IGAS""
--, ""Code thème régional""
--, ""Thème régional""
--, ""Type d'orientation""
--, ""Commanditaire principal""
--, ""Référent thématique""
--, ""Références règlementaires""
, ""Type de mission""
, ""Modalité d'investigation"" AS modalite_d_investigation
, ""Type de planification""
, ""Modalité de la mission""
--, ""Critère de ciblage 1""
--, ""Critère de ciblage 2""
--, ""Critère de ciblage 3""
, ""Mission conjointe avec 1""
, ""Mission conjointe avec 2""
--, ""Code UAI""
--, ""Code RPPS""
--, ""Code SIRET""
, ""Département""
, ""Commune""
, ""Adresse""
, ""Groupe de cibles""
, ""Cible""
, ""Caractère juridique""
, ""Type de cible""
, ""Code FINESS""
--, ""Nom Agent 1""
--, ""Prénom Agent 1""
--, ""Rôle mission agent 1""
--, ""Profession agent 1""
--, ""Statut agent 1""
--, ""Département agent 1""
--, ""Temps total agent 1""
--, ""Nom Agent 2""
--, ""Prénom Agent 2""
--, ""Rôle mission agent 2""
--, ""Profession agent 2""
--, ""Statut agent 2""
--, ""Département agent 2""
--, ""Temps total agent 2""
--, ""Nom Agent 3""
--, ""Prénom Agent 3""
--, ""Rôle mission agent 3""
--, ""Profession agent 3""
--, ""Statut agent 3""
--, ""Département agent 3""
--, ""Temps total agent 3""
--, ""Nom Agent 4""
--, ""Prénom Agent 4""
--, ""Rôle mission agent 4""
--, ""Profession agent 4""
--, ""Statut agent 4""
--, ""Département agent 4""
--, ""Temps total agent 4""
--, ""Nom Agent 5""
--, ""Prénom Agent 5""
--, ""Rôle mission agent 5""
--, ""Profession agent 5""
--, ""Statut agent 5""
--, ""Département agent 5""
--, ""Temps total agent 5""
--, ""Nom Agent 6""
--, ""Prénom Agent 6""
--, ""Rôle mission agent 6""
--, ""Profession agent 6""
--, ""Statut agent 6""
--, ""Département agent 6""
--, ""Temps total agent 6""
--, ""Nom Agent 7""
--, ""Prénom Agent 7""
--, ""Rôle mission agent 7""
--, ""Profession agent 7""
--, ""Statut agent 7""
--, ""Département agent 7""
--, ""Temps total agent 7""
--, ""Nom Agent 8""
--, ""Prénom Agent 8""
--, ""Rôle mission agent 8""
--, ""Profession agent 8""
--, ""Statut agent 8""
--, ""Département agent 8""
--, ""Temps total agent 8""
--, ""Nom Agent 9""
--, ""Prénom Agent 9""
--, ""Rôle mission agent 9""
--, ""Profession agent 9""
--, ""Statut agent 9""
--, ""Département agent 9""
--, ""Temps total agent 9""
--, ""Nom Agent 10""
--, ""Prénom Agent 10""
--, ""Rôle mission agent 10""
--, ""Profession agent 10""
--, ""Statut agent 10""
--, ""Département agent 10""
--, ""Temps total agent 10""
--, ""Commentaire""
--, ""Période de réalisation""
, ""Date provisoire """"Début Mission""""""
, ""Date réelle """"Début Mission""""""
--, ""Etat d'avancement """"Début Mission""""""
, CASE
	WHEN LENGTH(""Date provisoire """"Visite"""""" )=10 THEN SUBSTR(""Date provisoire """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date provisoire """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date provisoire """"Visite"""""" ,1,2) || "" 00:00:00""
	ELSE ""Date provisoire """"Visite"""""" 
END AS ""Date provisoire """"Visite""""""
, CASE
	WHEN LENGTH(""Date réelle """"Visite"""""" )=10 THEN SUBSTR(""Date réelle """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,1,2) || "" 00:00:00""
	ELSE ""Date réelle """"Visite"""""" 
END AS ""Date réelle """"Visite""""""
--, ""Etat d'avancement """"Visite""""""
--, ""Date provisoire """"Rapport""""""
--, ""Date réelle """"Rapport""""""
--, ""Etat d'avancement """"Rapport""""""
, ""Date provisoire """"Fin Mission""""""
, ""Date réelle """"Fin Mission""""""
--, ""Etat d'avancement """"Fin Mission""""""
--, ""Commentaire.1""
--, ""Niveau de risque""
--, ""Nombre d'écarts""
--, ""Nombre de remarques""
--, ""Injonction""
--, ""Complément""
--, ""Prescription""
--, ""Recommandation""
--, ""Saisine CNG""
--, ""Saisine juridiction/ordinale""
--, ""Saisine parquet""
--, ""Autre saisine""
--, ""Commentaire.2""
, ""Statut de la mission""
, CASE 
	WHEN LENGTH(""Code FINESS"")=8 THEN '0' || ""Code FINESS""
	ELSE ""Code FINESS""
END AS CD_FINESS
FROM sa_siicea_missions_20250210
WHERE 1=1
-- filtre sur la période
AND (
		(""Date réelle """"Visite"""""" = '' 
			AND (CASE
				WHEN LENGTH(""Date provisoire """"Visite"""""" )=10 THEN SUBSTR(""Date provisoire """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date provisoire """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date provisoire """"Visite"""""" ,1,2) || "" 00:00:00""
				ELSE ""Date provisoire """"Visite"""""" 
			END) > ""2024-12-31 00:00:00"") 
		OR (
			CASE
				WHEN LENGTH(""Date réelle """"Visite"""""" )=10 THEN SUBSTR(""Date réelle """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,1,2) || "" 00:00:00""
				ELSE ""Date réelle """"Visite"""""" 
			END) > ""2024-12-31 00:00:00"")
AND ""Statut de la mission"" NOT IN ('Clôturé'
	, 'Abandonné')
-- filtre sur le secteur ESMS
AND ""Secteur d'intervention"" = 'Médico-social'
-- filtre sur le type d'établissement
AND ""Type de cible"" = 'Etablissements et Services pour Personnes Agées'
-- filtre des thèmes IGAS (on ne conserve que ce qui concerne les soins)
AND ""Code thème IGAS"" IN (
'MS634D13'
, 'MS634D13'
, 'MS634N1'
, 'MS634E1'
, 'MS634D12'
, 'MS634R1'
, 'MS634D11'
, 'MS634D15'
, 'MS634C10'
, 'MS634C10'
)
-- filtre sur les types de mission (on ne conserve que les types inspeciton et contrôle)
AND ""Type de mission"" NOT IN (
'Audit'
, 'Audit franco-wallon'
, 'Evaluation'
, 'Visites de conformité'
, 'Enquête administrative'
)"
TdBICSiiceaMissionsReal,"CREATE VIEW TdBICSiiceaMissionsReal AS -- MatriceSiiceaMissionsReal source

SELECT 
""Identifiant de la mission""
--, ""Mission proposée par""
--, ""Secteur d'intervention""
, ""Code thème IGAS""
, ""Thème IGAS""
--, ""Code thème régional""
--, ""Thème régional""
--, ""Type d'orientation""
--, ""Commanditaire principal""
--, ""Référent thématique""
--, ""Références règlementaires""
, ""Type de mission""
, ""Modalité dinvestigation"" AS modalite_d_investigation
, ""Type de planification""
, ""Modalité de la mission""
--, ""Critère de ciblage 1""
--, ""Critère de ciblage 2""
--, ""Critère de ciblage 3""
, ""Mission conjointe avec 1""
, ""Mission conjointe avec 2""
--, ""Code UAI""
--, ""Code RPPS""
--, ""Code SIRET""
, ""Département""
, ""Commune""
, ""Adresse""
, ""Groupe de cibles""
, ""Cible""
, ""Caractère juridique""
, ""Type de cible""
, ""Code FINESS""
--, ""Nom Agent 1""
--, ""Prénom Agent 1""
--, ""Rôle mission agent 1""
--, ""Profession agent 1""
--, ""Statut agent 1""
--, ""Département agent 1""
--, ""Temps total agent 1""
--, ""Nom Agent 2""
--, ""Prénom Agent 2""
--, ""Rôle mission agent 2""
--, ""Profession agent 2""
--, ""Statut agent 2""
--, ""Département agent 2""
--, ""Temps total agent 2""
--, ""Nom Agent 3""
--, ""Prénom Agent 3""
--, ""Rôle mission agent 3""
--, ""Profession agent 3""
--, ""Statut agent 3""
--, ""Département agent 3""
--, ""Temps total agent 3""
--, ""Nom Agent 4""
--, ""Prénom Agent 4""
--, ""Rôle mission agent 4""
--, ""Profession agent 4""
--, ""Statut agent 4""
--, ""Département agent 4""
--, ""Temps total agent 4""
--, ""Nom Agent 5""
--, ""Prénom Agent 5""
--, ""Rôle mission agent 5""
--, ""Profession agent 5""
--, ""Statut agent 5""
--, ""Département agent 5""
--, ""Temps total agent 5""
--, ""Nom Agent 6""
--, ""Prénom Agent 6""
--, ""Rôle mission agent 6""
--, ""Profession agent 6""
--, ""Statut agent 6""
--, ""Département agent 6""
--, ""Temps total agent 6""
--, ""Nom Agent 7""
--, ""Prénom Agent 7""
--, ""Rôle mission agent 7""
--, ""Profession agent 7""
--, ""Statut agent 7""
--, ""Département agent 7""
--, ""Temps total agent 7""
--, ""Nom Agent 8""
--, ""Prénom Agent 8""
--, ""Rôle mission agent 8""
--, ""Profession agent 8""
--, ""Statut agent 8""
--, ""Département agent 8""
--, ""Temps total agent 8""
--, ""Nom Agent 9""
--, ""Prénom Agent 9""
--, ""Rôle mission agent 9""
--, ""Profession agent 9""
--, ""Statut agent 9""
--, ""Département agent 9""
--, ""Temps total agent 9""
--, ""Nom Agent 10""
--, ""Prénom Agent 10""
--, ""Rôle mission agent 10""
--, ""Profession agent 10""
--, ""Statut agent 10""
--, ""Département agent 10""
--, ""Temps total agent 10""
--, ""Commentaire""
--, ""Période de réalisation""
, ""Date provisoire """"Début Mission""""""
, ""Date réelle """"Début Mission""""""
--, ""Etat d'avancement """"Début Mission""""""
, CASE
	WHEN LENGTH(""Date provisoire """"Visite"""""" )=10 THEN SUBSTR(""Date provisoire """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date provisoire """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date provisoire """"Visite"""""" ,1,2) || "" 00:00:00""
	ELSE ""Date provisoire """"Visite"""""" 
END AS ""Date provisoire """"Visite""""""
, CASE
	WHEN LENGTH(""Date réelle """"Visite"""""" )=10 THEN SUBSTR(""Date réelle """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,1,2) || "" 00:00:00""
	ELSE ""Date réelle """"Visite"""""" 
END AS ""Date réelle """"Visite""""""
--, ""Etat d'avancement """"Visite""""""
--, ""Date provisoire """"Rapport""""""
--, ""Date réelle """"Rapport""""""
--, ""Etat d'avancement """"Rapport""""""
, ""Date provisoire """"Fin Mission""""""
, ""Date réelle """"Fin Mission""""""
--, ""Etat d'avancement """"Fin Mission""""""
--, ""Commentaire.1""
--, ""Niveau de risque""
--, ""Nombre d'écarts""
--, ""Nombre de remarques""
--, ""Injonction""
--, ""Complément""
--, ""Prescription""
--, ""Recommandation""
--, ""Saisine CNG""
--, ""Saisine juridiction/ordinale""
--, ""Saisine parquet""
--, ""Autre saisine""
--, ""Commentaire.2""
, ""Statut de la mission""
, CASE 
	WHEN LENGTH(""Code FINESS"")=8 THEN '0' || ""Code FINESS""
	ELSE ""Code FINESS""
END AS CD_FINESS
FROM sa_siicea_missions_20250210
WHERE 1=1
-- filtre sur la période
AND (
		(CASE
			WHEN LENGTH(""Date réelle """"Visite"""""" )=10 THEN SUBSTR(""Date réelle """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,1,2) || "" 00:00:00""
			ELSE ""Date réelle """"Visite"""""" 
		END) >= '2022-01-01 00:00:00' 
		AND (CASE
			WHEN LENGTH(""Date réelle """"Visite"""""" )=10 THEN SUBSTR(""Date réelle """"Visite"""""" ,7,4) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,4,2) || ""-"" || SUBSTR(""Date réelle """"Visite"""""" ,1,2) || "" 00:00:00""
			ELSE ""Date réelle """"Visite"""""" 
		END) <= '2024-12-31 00:00:00')
-- filtre sur le statut réalisé 
AND ""Statut de la mission"" IN ('Clôturé'
	, 'Maintenu')
-- filtre sur le secteur ESMS
AND ""Secteur dintervention"" = 'Médico-social'
-- filtre sur le type d'établissement
AND ""Type de cible"" = 'Etablissements et Services pour Personnes Agées'
-- filtre des thèmes IGAS (on ne conserve que ce qui concerne les soins)
AND ""Code thème IGAS"" IN (
'MS634D13'
, 'MS634D13'
, 'MS634N1'
, 'MS634E1'
, 'MS634D12'
, 'MS634R1'
, 'MS634D11'
, 'MS634D15'
, 'MS634C10'
, 'MS634C10'
)
-- filtre sur les types de mission (on ne conserve que les types inspeciton et contrôle)
AND ""Type de mission"" NOT IN (
'Audit'
, 'Audit franco-wallon'
, 'Evaluation'
, 'Visites de conformité'
, 'Enquête administrative'
)"
TdBICSiiceaCibles,"CREATE VIEW TdBICSiiceaCibles AS SELECT 
*
FROM sa_siicea_cibles_20250210
WHERE FINESS != """""
