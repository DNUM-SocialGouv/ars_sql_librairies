name,sql
TDB_MISSIONS_SANCTIONS,"CREATE VIEW TDB_MISSIONS_SANCTIONS AS
-- Nombre d'EHPAD différents contrôlés
-- Taux d'EHPAD différents contrôlés (en %) 
WITH ehpad_control AS (
SELECT
reg_lb ,
NB_ETAB_CONTROLE ,
NB_ETAB_CONTROLE_NB_EHPAD 
FROM DWH_MISSIONS_AGG_region
ORDER BY reg_lb ASC
)
-- Nombre d'I-C d'EHPAD réalisées
, missions_real AS (
SELECT 
reg_lb ,
SUM(NB_MISSION) AS NB_MISSIONS
FROM DWH_MISSIONS
--WHERE filtre = ""Hors santé-environnement""
GROUP BY reg_lb
ORDER BY reg_lb ASC
)
-- Nombre d'I-C clôturées
, missions_clot AS (
SELECT 
reg_lb ,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSIONS_CLOTUREES
FROM DWH_MISSIONS_SANCTION
--WHERE filtre = ""Hors santé-environnement""
GROUP BY reg_lb
ORDER BY reg_lb ASC
)
-- Nombre d'I-C clôturées sans suites coercitives (injonction, prescription) ni saisine
, missions_clo_ss_s AS (
SELECT 
reg_lb ,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSIONS_CLOTUREES_SANS_S
FROM DWH_MISSIONS_SANCTION
--WHERE filtre = ""Hors santé-environnement"" 
WHERE SANCTION = ""sans sanction""
GROUP BY reg_lb
ORDER BY reg_lb ASC
)
-- Nombre de signalements au Parquet effectués (art. 40 CPP)
, saisines_parq AS (
SELECT 
reg_lb ,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_SAISINES_PARQUET
FROM DWH_SUITES
WHERE Complément = ""Saisine parquet""
GROUP BY reg_lb
ORDER BY reg_lb ASC
)
-- nombre d'injonctions
, injonctions AS (
SELECT 
reg_lb ,
SUM(NB_SUITE) AS NB_INJONC
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Injonction""
GROUP BY
reg_lb
)
-- nombre de prescriptions
, prescriptions AS (
SELECT 
reg_lb ,
SUM(NB_SUITE) AS NB_PRESCR
FROM DWH_SUITES 
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Prescription""
GROUP BY
reg_lb
)
-- nombre d'injonctions + prescriptions
, injonc_prescr AS (
SELECT 
reg_lb ,
SUM(NB_SUITE) AS NB_INJONC_PRESCR
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE (""Type de décision"" = ""Injonction"" OR ""Type de décision"" = ""Prescription"")
GROUP BY
reg_lb
)
--
-- table qui croise tous les indicateurs
, cross_all AS (
SELECT 
ehpad_control.reg_lb AS ""Région"",
NB_ETAB_CONTROLE AS ""Nombre d'EHPAD différents contrôlés"",
NB_ETAB_CONTROLE_NB_EHPAD AS ""Taux d'EHPAD différents contrôlés (en %)"",
NB_MISSIONS AS ""Nombre d'I-C d'EHPAD réalisées"",
NB_MISSIONS_CLOTUREES AS ""Nombre d'I-C clôturées"",
NB_MISSIONS_CLOTUREES_SANS_S AS ""Nombre d'I-C clôturées sans suites coercitives (injonction, prescription) ni saisine"",
-- Taux d'I-C clôturées sans suites coercitives (injonction, prescription) ni saisine (en %)
(CAST(NB_MISSIONS_CLOTUREES_SANS_S AS FLOAT) / CAST(NB_MISSIONS_CLOTUREES AS FLOAT))*100 AS ""Taux d'I-C clôturées sans suites coercitives (injonction, prescription) ni saisine (en %)"",
NB_SAISINES_PARQUET AS ""Nombre de signalements au Parquet effectués (art. 40 CPP)"" ,
NB_INJONC AS ""Nbr total injonctions"",
(CAST(NB_INJONC AS FLOAT) / CAST(NB_MISSIONS AS FLOAT)) AS ""Nbr injonctions moyen / I-C réalisé"" ,
NB_PRESCR AS ""Nbr total prescriptions"",
(CAST(NB_PRESCR AS FLOAT) / CAST(NB_MISSIONS AS FLOAT)) AS ""Nbr prescriptions moyen / I-C réalisé"" ,
NB_INJONC_PRESCR AS ""Nbr total injonctions + prescriptions"" ,
(CAST(NB_INJONC_PRESCR AS FLOAT) / CAST(NB_MISSIONS AS FLOAT)) AS ""Nbr injonctions et prescriptions moyen par I-C réalisé""
FROM ehpad_control
LEFT JOIN missions_real ON ehpad_control.reg_lb = missions_real.reg_lb
LEFT JOIN missions_clot ON ehpad_control.reg_lb = missions_clot.reg_lb
LEFT JOIN missions_clo_ss_s ON ehpad_control.reg_lb = missions_clo_ss_s.reg_lb
LEFT JOIN saisines_parq ON ehpad_control.reg_lb = saisines_parq.reg_lb
LEFT JOIN injonctions ON ehpad_control.reg_lb = injonctions.reg_lb
LEFT JOIN prescriptions ON ehpad_control.reg_lb = prescriptions.reg_lb
LEFT JOIN injonc_prescr ON ehpad_control.reg_lb = injonc_prescr.reg_lb
)
SELECT 
*
FROM cross_all"
TDB_INJONCTION,"CREATE VIEW TDB_INJONCTION AS 
-- injonctions par thème, sous-thème et statut juridique
SELECT 
reg_lb AS ""Région"",
statut_juridique_lb AS ""Statut juridique"",
""Thème Décision"" ,
""Sous-thème Décision"" ,
SUM(NB_SUITE) AS ""Injonctions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Injonction""
GROUP BY
reg_lb ,
statut_juridique_lb,
""Thème Décision"" ,
""Sous-thème Décision"""
TDB_INJONCTIONS_PRESCRIPTIONS,"CREATE VIEW TDB_INJONCTIONS_PRESCRIPTIONS AS 
-- injonctions + prescriptions par thème, sous thème et statut juridique
SELECT
reg_lb AS ""Région"",
statut_juridique_lb AS ""Statut juridique"",
""Thème Décision"" ,
""Sous-thème Décision"" ,
SUM(NB_SUITE) AS ""Injonctions + prescriptions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE (""Type de décision"" = ""Injonction"" OR ""Type de décision"" = ""Prescription"")
GROUP BY
reg_lb ,
statut_juridique_lb,
""Thème Décision"" ,
""Sous-thème Décision"""
TDB_PRESCRIPTION,"CREATE VIEW TDB_PRESCRIPTION AS
-- prescriptions par thème, sous-thème et statut juridique
SELECT
reg_lb AS ""Région"",
statut_juridique_lb AS ""Statut juridique"",
""Thème Décision"" ,
""Sous-thème Décision"" ,
SUM(NB_SUITE) AS ""Prescriptions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Prescription""
GROUP BY
reg_lb ,
statut_juridique_lb,
""Thème Décision"" ,
""Sous-thème Décision"""
DWH_MISSIONS_PROG,"CREATE VIEW DWH_MISSIONS_PROG AS 
-- # SCRIPT des missions programmées
-- table lien entre code commune et codes département et région
WITH 
-- table qui croise ODS_IC avec les ref geo / cibles et fait les autres transfo
missions_prev_complet AS (
SELECT
CASE
	WHEN missions_prev.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_prev.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_prev.CD_FINESS = """" THEN IIF(LENGTH(missions_prev.""Département"")=1, ""0"" || missions_prev.""Département"", missions_prev.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_prev.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
missions_prev.CD_FINESS AS finess_cd,
missions_prev.Cible,
missions_prev.""Identifiant de la mission"",
t_finess.statut_jur_niv2_code AS statut_juridique_cd,
IIF(t_finess.statut_jur_niv2_lib = '', ""NC"", t_finess.statut_jur_niv2_lib) AS statut_juridique_lb,
--missions_prev.RAISON_SOCIALE_SIREN AS groupe,
missions_prev.""Type de mission"" AS type_de_mission,
--CASE 
--	WHEN missions_prev.""Type de mission"" = ""contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""Contrôle sur pièces EHPAD"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""EHPAD Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""Ctrl_sur_Pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""Inspection"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""Inspection Technique"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""inspection"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""Evaluation"" THEN ""Evaluation""
--	WHEN missions_prev.""Type de mission"" = ""Contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""Enquête administrative"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""Visites de conformité"" THEN ""Visites de conformité""
--	WHEN missions_prev.""Type de mission"" = ""Contrôle sur place / Visite de vérification"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""Inspection_SE"" THEN ""Inspection santé-environnement""
--	WHEN missions_prev.""Type de mission"" = ""Inspection_prgm21"" THEN ""Contrôle sur place""
--    WHEN missions_prev.""Type de mission"" = ""Inspection_prgm23"" THEN ""Contrôle sur place""
--    WHEN missions_prev.""Type de mission"" = ""Inspection_prgm24"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_prev.""Type de mission"" = ""Contrôle sur pièces (Avec contradictoire)"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""Controle sur pièces contradictoire"" THEN ""Contrôle sur pièces""
--	WHEN missions_prev.""Type de mission"" = ""Suites d'inspection"" THEN ""Contrôle sur place""
--	ELSE ""NC""
--END
modalite_d_investigation AS CTRL_PL_PI,
--group_mottif_sante_env.group_hsa_sa,
--IIF(group_mottif_sante_env.group_hsa_sa = 'motif_hsa' AND ODS_IC.""Type de mission"" != 'Evaluation' AND ODS_IC.""Type de mission"" != 'Visites de conformité',""Hors santé-environnement"",""Santé-environnement"") AS filtre,
missions_prev.""Statut de la mission"",
missions_prev.""Date provisoire """"Visite"""""",
--groupe_diamant.GROUPE AS GROUPE_2,
sa_cibles.""Groupe de cibles"" AS groupe_siicea,
IIF(missions_prev.""Type de planification"" = 'Inopiné', 'Programmé', missions_prev.""Type de planification"") AS ""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
CASE 
	WHEN (""Mission conjointe avec 1"" LIKE ""%Conseil départemental%"" OR ""Mission conjointe avec 1"" LIKE ""%Département%"" OR ""Mission conjointe avec 2"" LIKE ""%Conseil départemental%"") THEN ""ARS / CD""
	WHEN ""Mission conjointe avec 1"" = '' OR ""Mission conjointe avec 1"" = 'Non' THEN ""Non conjointe""
	ELSE ""ARS + autre administration""
END AS mission_conjointe,
IIF(""Modalité de la mission""='', 'NC', ""Modalité de la mission"") AS ""Modalité de la mission""
--FROM ODS_IC 
FROM TdBICSiiceaMissionsprog_20250210 missions_prev
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_prev.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_prev.""Département"")=1, ""0"" || missions_prev.""Département"", missions_prev.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG
--LEFT JOIN group_mottif_sante_env ON ODS_IC.""Identifiant de la mission"" = group_mottif_sante_env.""Identifiant de la mission""
--LEFT JOIN groupe_diamant ON ODS_IC.CD_FINESS = groupe_diamant.FINESS
LEFT JOIN TdBICSiiceaCibles_20250210 sa_cibles ON missions_prev.CD_FINESS = sa_cibles.FINESS 
--WHERE ""Type de mission"" NOT IN (
--'Evaluation',
--'Visites de conformité', 
--'Audit franco-wallon')
),
dwh AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
statut_juridique_cd,
statut_juridique_lb,
"""" AS groupe,
type_de_mission,
CTRL_PL_PI,
"""" AS filtre,
""Statut de la mission"",
""Date provisoire """"Visite"""""",
"""" AS GROUPE_2,
groupe_siicea,
""Type de planification"",
mission_conjointe,
""Modalité de la mission"",
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION
FROM missions_prev_complet
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
statut_juridique_cd,
statut_juridique_lb,
groupe,
type_de_mission,
CTRL_PL_PI,
filtre,
""Statut de la mission"",
""Date provisoire """"Visite"""""",
GROUPE_2,
groupe_siicea,
""Type de planification"",
mission_conjointe,
""Modalité de la mission""
)
SELECT 
*
FROM dwh"
y2_modalites,"CREATE VIEW y2_modalites AS WITH modalites AS (
    SELECT
        CASE 
            WHEN ""Modalité de la mission"" = 'Inopinée' THEN CAST(NB_MISSION AS FLOAT)
        END AS inopinee,
        CASE 
            WHEN ""Modalité de la mission"" = 'Annoncée' THEN CAST(NB_MISSION AS FLOAT)
        END AS anoncee
    FROM DWH_MISSIONS
    WHERE CTRL_PL_PI = ""Sur site""
)
SELECT 
    ROUND((SUM(inopinee) / NULLIF(SUM(inopinee) + SUM(anoncee), 0)) * 100, 2) 
    AS ""Taux d’inspections sur place réalisées de manière inopinée"",
    ROUND((SUM(anoncee) / NULLIF(SUM(inopinee) + SUM(anoncee), 0)) * 100, 2) 
    AS ""Taux d’inspections sur place réalisées de manière annoncée au gestionnaire""
FROM modalites"
y3_juridique,"CREATE VIEW y3_juridique AS 
WITH 
	juridique AS (
		SELECT 
			CASE
				WHEN statut_juridique_cd = ""1100"" OR statut_juridique_cd = ""1200"" THEN CAST(NB_MISSION AS FLOAT)
			END AS ""public""
			, CASE
				WHEN statut_juridique_cd = ""2100"" THEN CAST(NB_MISSION AS FLOAT)
			END AS ""Organisme Privé à But non Lucratif""
			, CASE
				WHEN statut_juridique_cd = ""2200"" THEN CAST(NB_MISSION AS FLOAT)
			END AS ""Organisme Privé à Caractère Commercial""
		FROM DWH_MISSIONS)
	SELECT
		ROUND((SUM(""public"") / NULLIF(SUM(""public"") + SUM(""Organisme Privé à But non Lucratif"") + SUM(""Organisme Privé à Caractère Commercial""), 0)) * 100, 2) 
	    AS ""Taux de missions d'I-C des organismes publics""
	    , ROUND((SUM(""Organisme Privé à But non Lucratif"") / NULLIF(SUM(""public"") + SUM(""Organisme Privé à But non Lucratif"") + SUM(""Organisme Privé à Caractère Commercial""), 0)) * 100, 2) 
	    AS ""Taux de missions d'I-C des organismes privés à but lucratif""
	    , ROUND((SUM(""Organisme Privé à Caractère Commercial"") / NULLIF(SUM(""public"") + SUM(""Organisme Privé à But non Lucratif"") + SUM(""Organisme Privé à Caractère Commercial""), 0)) * 100, 2) 
	    AS ""Taux de missions d'I-C des organismes privés à caractère commercial""
	FROM juridique"
DWH_MISSIONS,"CREATE VIEW DWH_MISSIONS AS 
-- # SCRIPT des missions
-- table lien entre code commune et codes département et région
WITH 
-- table qui croise ODS_IC avec les ref geo / cibles et fait les autres transfo
missions_real_complet AS (
SELECT
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
missions_real.CD_FINESS AS finess_cd,
missions_real.Cible,
missions_real.""Identifiant de la mission"",
t_finess.statut_jur_niv2_code AS statut_juridique_cd,
IIF(t_finess.statut_jur_niv2_lib = '', ""NC"", t_finess.statut_jur_niv2_lib) AS statut_juridique_lb,
missions_real.""Type de mission"" AS type_de_mission,
--CASE 
--	WHEN missions_real.""Type de mission"" = ""contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces EHPAD"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""EHPAD Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Ctrl_sur_Pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Inspection"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Inspection Technique"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""inspection"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Evaluation"" THEN ""Evaluation""
--	WHEN missions_real.""Type de mission"" = ""Contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Enquête administrative"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Visites de conformité"" THEN ""Visites de conformité""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur place / Visite de vérification"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Inspection_SE"" THEN ""Inspection santé-environnement""
--	WHEN missions_real.""Type de mission"" = ""Inspection_prgm21"" THEN ""Contrôle sur place""
--    WHEN missions_real.""Type de mission"" = ""Inspection_prgm23"" THEN ""Contrôle sur place""
--    WHEN missions_real.""Type de mission"" = ""Inspection_prgm24"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces (Avec contradictoire)"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Controle sur pièces contradictoire"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Suites d'inspection"" THEN ""Contrôle sur place""
--	ELSE ""NC""
--END
modalite_d_investigation AS CTRL_PL_PI,
missions_real.""Statut de la mission"",
missions_real.""Date réelle """"Visite"""""",
sa_cibles.""Groupe de cibles"" AS groupe_siicea,
IIF(missions_real.""Type de planification"" = 'Inopiné', 'Programmé', missions_real.""Type de planification"") AS ""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
CASE 
	WHEN (""Mission conjointe avec 1"" LIKE ""%Conseil départemental%"" OR ""Mission conjointe avec 1"" LIKE ""%Département%"" OR ""Mission conjointe avec 2"" LIKE ""%Conseil départemental%"") THEN ""ARS / CD""
	WHEN ""Mission conjointe avec 1"" = '' OR ""Mission conjointe avec 1"" = 'Non' THEN ""Non conjointe""
	ELSE ""ARS + autre administration""
END AS mission_conjointe,
IIF(""Modalité de la mission""='', 'NC', ""Modalité de la mission"") AS ""Modalité de la mission""
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG
LEFT JOIN TdBICSiiceaCibles_20250210 sa_cibles ON missions_real.CD_FINESS = sa_cibles.FINESS 
),
dwh AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
statut_juridique_cd,
statut_juridique_lb,
CASE
	WHEN statut_juridique_cd = ""1100"" OR statut_juridique_cd = ""1200"" THEN ""Organisme public""
	ELSE statut_juridique_lb
END AS statut_juridique_lb_corr,
"""" AS groupe,
type_de_mission,
CTRL_PL_PI,
"""" AS filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
"""" AS GROUPE_2,
groupe_siicea,
""Type de planification"",
mission_conjointe,
""Modalité de la mission"",
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION
FROM missions_real_complet
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
statut_juridique_cd,
statut_juridique_lb,
groupe,
type_de_mission,
CTRL_PL_PI,
filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
GROUPE_2,
groupe_siicea,
""Type de planification"",
mission_conjointe,
""Modalité de la mission""
)
SELECT 
*
FROM dwh"
y6_taux_sanction,"CREATE VIEW y6_taux_sanction AS 
WITH sans_sanction AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS sans_sanction
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""sans sanction""
)
, total AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS total
	FROM 
		DWH_MISSIONS_SANCTION
)
, avec_sanction AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS avec_sanction
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""avec sanction""
)
SELECT
    sans_sanction AS ""Nombre d'I-C clôturées sans sanction"",
    total AS ""Nombre total d'I-C clôturées"",
    ROUND((CAST(sans_sanction AS FLOAT) / NULLIF(CAST(total AS FLOAT), 0)) * 100, 2) AS ""Taux d'I-C clôturées sans sanction"",
	avec_sanction AS ""Nombre d'I-C clôturées avec sanction"",
	ROUND((CAST(avec_sanction AS FLOAT) / NULLIF(CAST(total AS FLOAT), 0)) * 100, 2) AS ""Taux d'I-C clôturées avec sanction""
FROM 
	sans_sanction 
LEFT JOIN 
	total
LEFT JOIN 
	avec_sanction"
DWH_MISSIONS_SANCTION,"CREATE VIEW DWH_MISSIONS_SANCTION AS 
-- # SCRIPT des missions
-- table lien entre code commune et codes département et région
WITH
-- table qui croise ODS_IC avec les ref geo / cibles et fait les autres transfo
missions_real_complet AS (
SELECT
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
missions_real.CD_FINESS AS finess_cd,
missions_real.Cible,
missions_real.""Identifiant de la mission"",
t_finess.statut_jur_niv2_code AS statut_juridique_cd,
IIF(t_finess.statut_jur_niv2_lib = '', ""NC"", t_finess.statut_jur_niv2_lib) AS statut_juridique_lb,
CASE
	WHEN t_finess.statut_jur_niv2_code = ""1100"" OR t_finess.statut_jur_niv2_code = ""1200"" THEN ""Organisme public""
	ELSE IIF(t_finess.statut_jur_niv2_lib = '', ""NC"", t_finess.statut_jur_niv2_lib)
END AS statut_juridique_lb_corr,
--missions_real.RAISON_SOCIALE_SIREN AS groupe,
missions_real.""Type de mission"" AS type_de_mission,
--CASE 
--	WHEN missions_real.""Type de mission"" = ""contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces EHPAD"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""EHPAD Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Ctrl_sur_Pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Inspection"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Inspection Technique"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""inspection"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Evaluation"" THEN ""Evaluation""
--	WHEN missions_real.""Type de mission"" = ""Contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Enquête administrative"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Visites de conformité"" THEN ""Visites de conformité""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur place / Visite de vérification"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Inspection_SE"" THEN ""Inspection santé-environnement""
--	WHEN missions_real.""Type de mission"" = ""Inspection_prgm21"" THEN ""Contrôle sur place""
--    WHEN missions_real.""Type de mission"" = ""Inspection_prgm23"" THEN ""Contrôle sur place""
--    WHEN missions_real.""Type de mission"" = ""Inspection_prgm24"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces (Avec contradictoire)"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Controle sur pièces contradictoire"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Suites d'inspection"" THEN ""Contrôle sur place""
--	ELSE ""NC""
--END
modalite_d_investigation AS CTRL_PL_PI,
--group_mottif_sante_env.group_hsa_sa,
--IIF(group_mottif_sante_env.group_hsa_sa = 'motif_hsa' AND ODS_IC.""Type de mission"" != 'Evaluation' AND ODS_IC.""Type de mission"" != 'Visites de conformité',""Hors santé-environnement"",""Santé-environnement"") AS filtre,
missions_real.""Statut de la mission"",
missions_real.""Date réelle """"Visite"""""",
--groupe_diamant.GROUPE AS GROUPE_2,
sa_cibles.""Groupe de cibles"" AS groupe_siicea,
IIF(missions_real.""Type de planification"" = 'Inopiné', 'Programmé', missions_real.""Type de planification"") AS ""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
CASE 
	WHEN (""Mission conjointe avec 1"" LIKE ""%Conseil départemental%"" OR ""Mission conjointe avec 1"" LIKE ""%Département%"" OR ""Mission conjointe avec 2"" LIKE ""%Conseil départemental%"") THEN ""ARS / CD""
	WHEN ""Mission conjointe avec 1"" = '' OR ""Mission conjointe avec 1"" = 'Non' THEN ""Non conjointe""
	ELSE ""ARS + autre administration""
END AS mission_conjointe,
IIF(""Modalité de la mission""='', 'NC', ""Modalité de la mission"") AS ""Modalité de la mission""
--FROM ODS_IC 
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG
--LEFT JOIN group_mottif_sante_env ON ODS_IC.""Identifiant de la mission"" = group_mottif_sante_env.""Identifiant de la mission""
--LEFT JOIN groupe_diamant ON ODS_IC.CD_FINESS = groupe_diamant.FINESS
LEFT JOIN TdBICSiiceaCibles_20250210 sa_cibles ON missions_real.CD_FINESS = sa_cibles.FINESS 
--WHERE ""Type de mission"" NOT IN (
--'Evaluation',
--'Visites de conformité', 
--'Audit franco-wallon')
)
, cross_miss_sui AS (SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
missions_real_complet.""Identifiant de la mission"",
statut_juridique_cd,
statut_juridique_lb,
statut_juridique_lb_corr,
"""" AS groupe,
type_de_mission,
CTRL_PL_PI,
"""" AS group_hsa_sa,
"""" AS filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
"""" AS GROUPE_2,
groupe_siicea,
""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
mission_conjointe,
""Modalité de la mission"",
""Type de décision"",
Complément,
""Thème Décision"",
""Sous-thème Décision"",
COALESCE(SANCTION, 'sans_contrainte') AS SANCTION,
SUM(Nombre) AS NB_SUITE
--Nombre
FROM missions_real_complet
LEFT JOIN 
	(SELECT 
	""Identifiant de la mission"",
	""Type de décision"",
	Complément,
	""Thème Décision"",
	""Sous-thème Décision"",
	IIF(""Type de décision"" IN (
		'Injonction',
		'Prescription',
		'Saisine'
		), 'contrainte', 'sans_contrainte') AS SANCTION,
	Nombre
	FROM sa_siicea_decisions_20250210
) decisions ON missions_real_complet.""Identifiant de la mission""=decisions.""Identifiant de la mission"" 
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
missions_real_complet.""Identifiant de la mission"",
statut_juridique_cd,
statut_juridique_lb,
statut_juridique_lb_corr,
groupe,
type_de_mission,
CTRL_PL_PI,
group_hsa_sa,
filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
GROUPE_2,
groupe_siicea,
""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
mission_conjointe,
""Modalité de la mission"",
""Type de décision"",
Complément,
""Thème Décision"",
""Sous-thème Décision"",
COALESCE(SANCTION, 'sans_contrainte')
),
contrainte AS (SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
""Identifiant de la mission"",
statut_juridique_cd,
statut_juridique_lb,
statut_juridique_lb_corr,
groupe,
type_de_mission,
CTRL_PL_PI,
group_hsa_sa,
filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
GROUPE_2,
groupe_siicea,
""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
mission_conjointe,
""Modalité de la mission"",
""avec sanction"" AS AVEC_SANCTION
FROM cross_miss_sui
WHERE SANCTION = ""contrainte""
GROUP BY
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
""Identifiant de la mission"",
statut_juridique_cd,
statut_juridique_lb,
statut_juridique_lb_corr,
groupe,
type_de_mission,
CTRL_PL_PI,
group_hsa_sa,
filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
GROUPE_2,
groupe_siicea,
""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
mission_conjointe,
""Modalité de la mission""
)
SELECT 
--COUNT(DISTINCT ods_ic_complet.""Identifiant de la mission""),
--COUNT(DISTINCT ods_ic_complet.finess_cd)
--DISTINCT(ods_ic_complet.reg_lb)
missions_real_complet.*,
COALESCE(contrainte.AVEC_SANCTION, 'sans sanction') AS SANCTION
FROM missions_real_complet
LEFT JOIN contrainte ON missions_real_complet.""Identifiant de la mission"" = contrainte.""Identifiant de la mission""
WHERE missions_real_complet.""Statut de la mission"" = ""Clôturé""
--ORDER BY ods_ic_complet.reg_lb ASC
--WHERE ""Identifiant de la mission"" = '2022_PAC_00053'
--WHERE ""Identifiant de la mission"" = '2022_00062'
-- 22282 suites"
DWH_SUITES,"CREATE VIEW DWH_SUITES AS
-- # SCRIPT des missions
-- table lien entre code commune et codes département et région
WITH
-- table qui croise ODS_IC avec les ref geo / cibles et fait les autres transfo
missions_real_complet AS (
SELECT
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
missions_real.CD_FINESS AS finess_cd,
missions_real.Cible,
missions_real.""Identifiant de la mission"",
t_finess.statut_jur_niv2_code AS statut_juridique_cd,
IIF(t_finess.statut_jur_niv2_lib = '', ""NC"", t_finess.statut_jur_niv2_lib) AS statut_juridique_lb,
missions_real.""Type de mission"" AS type_de_mission,
--CASE 
--	WHEN missions_real.""Type de mission"" = ""contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces EHPAD"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""EHPAD Contrôle sur pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Ctrl_sur_Pièces"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Inspection"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Inspection Technique"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""inspection"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Evaluation"" THEN ""Evaluation""
--	WHEN missions_real.""Type de mission"" = ""Contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Enquête administrative"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Visites de conformité"" THEN ""Visites de conformité""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur place / Visite de vérification"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Inspection_SE"" THEN ""Inspection santé-environnement""
--	WHEN missions_real.""Type de mission"" = ""Inspection_prgm21"" THEN ""Contrôle sur place""
--    WHEN missions_real.""Type de mission"" = ""Inspection_prgm23"" THEN ""Contrôle sur place""
--    WHEN missions_real.""Type de mission"" = ""Inspection_prgm24"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""contrôle"" THEN ""Contrôle sur place""
--	WHEN missions_real.""Type de mission"" = ""Contrôle sur pièces (Avec contradictoire)"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Controle sur pièces contradictoire"" THEN ""Contrôle sur pièces""
--	WHEN missions_real.""Type de mission"" = ""Suites d'inspection"" THEN ""Contrôle sur place""
--	ELSE ""NC""
--END 
modalite_d_investigation AS CTRL_PL_PI,
missions_real.""Statut de la mission"",
missions_real.""Date réelle """"Visite"""""",
sa_cibles.""Groupe de cibles"" AS groupe_siicea,
IIF(missions_real.""Type de planification"" = 'Inopiné', 'Programmé', missions_real.""Type de planification"") AS ""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
CASE 
	WHEN (""Mission conjointe avec 1"" LIKE ""%Conseil départemental%"" OR ""Mission conjointe avec 1"" LIKE ""%Département%"" OR ""Mission conjointe avec 2"" LIKE ""%Conseil départemental%"") THEN ""ARS / CD""
	WHEN ""Mission conjointe avec 1"" = '' OR ""Mission conjointe avec 1"" = 'Non' THEN ""Non conjointe""
	ELSE ""ARS + autre administration""
END AS mission_conjointe,
IIF(""Modalité de la mission""='', 'NC', ""Modalité de la mission"") AS ""Modalité de la mission""
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG
LEFT JOIN TdBICSiiceaCibles_20250210 sa_cibles ON missions_real.CD_FINESS = sa_cibles.FINESS 
),
dwh AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
statut_juridique_cd,
statut_juridique_lb,
"""" AS groupe,
type_de_mission,
CTRL_PL_PI,
"""" AS filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
"""" AS GROUPE_2,
groupe_siicea,
""Type de planification"",
mission_conjointe,
""Modalité de la mission"",
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION
FROM missions_real_complet
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
statut_juridique_cd,
statut_juridique_lb,
type_de_mission,
CTRL_PL_PI,
""Statut de la mission"",
""Date réelle """"Visite"""""",
groupe_siicea,
""Type de planification"",
mission_conjointe,
""Modalité de la mission""
)
, cross_miss_sui AS (SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
missions_real_complet.""Identifiant de la mission"",
statut_juridique_cd,
IIF(statut_juridique_lb IS NULL, ""NC"", statut_juridique_lb) AS statut_juridique_lb,
CASE
	WHEN statut_juridique_cd = ""1100"" OR statut_juridique_cd = ""1200"" THEN ""Organisme public""
	ELSE statut_juridique_lb
END AS statut_juridique_lb_corr, 
"""" AS groupe,
type_de_mission,
CTRL_PL_PI,
"""" AS filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
"""" AS GROUPE_2,
groupe_siicea,
""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
mission_conjointe,
""Modalité de la mission"",
""Type de décision"",
Complément,
""Thème Décision"",
""Sous-thème Décision"",
""Statut de décision"",
COALESCE(SANCTION, 'sans_contrainte') AS SANCTION,
SUM(Nombre) AS NB_SUITE
--Nombre
FROM missions_real_complet
LEFT JOIN 
	(SELECT 
	""Identifiant de la mission"",
	""Type de décision"",
	Complément,
	""Thème Décision"",
	""Sous-thème Décision"",
	""Statut de décision"",
	IIF(""Type de décision"" IN (
		'Injonction',
		'Prescription',
		'Saisine'
		), 'contrainte', 'sans_contrainte') AS SANCTION,
	Nombre
	FROM sa_siicea_decisions_20250210 ""sa_decisions""
	) decisions ON missions_real_complet.""Identifiant de la mission""=decisions.""Identifiant de la mission"" 
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb,
finess_cd,
Cible,
missions_real_complet.""Identifiant de la mission"",
statut_juridique_cd,
statut_juridique_lb,
groupe,
type_de_mission,
CTRL_PL_PI,
filtre,
""Statut de la mission"",
""Date réelle """"Visite"""""",
GROUPE_2,
groupe_siicea,
""Type de planification"",
""Mission conjointe avec 1"",
""Mission conjointe avec 2"",
mission_conjointe,
""Modalité de la mission"",
""Type de décision"",
Complément,
""Thème Décision"",
""Sous-thème Décision"",
""Statut de décision"",
COALESCE(SANCTION, 'sans_contrainte')
	)
SELECT 
*
FROM cross_miss_sui"
y7_taux_sanction_modalite,"CREATE VIEW y7_taux_sanction_modalite AS 
WITH sans_sanction_sur_place AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS sans_sanction_sur_place
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""sans sanction""
		AND CTRL_PL_PI = ""Sur site""
)
, total_sur_place AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS total_sur_place
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		CTRL_PL_PI = ""Sur site""
)
, sans_sanction_sur_pieces AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS sans_sanction_sur_pieces
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""sans sanction""
		AND CTRL_PL_PI = ""Sur pièces""
)
, total_sur_pieces AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS total_sur_pieces
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		CTRL_PL_PI = ""Sur pièces""
)
SELECT 
sans_sanction_sur_place,
total_sur_place,
ROUND((CAST(sans_sanction_sur_place AS FLOAT) / NULLIF(CAST(total_sur_place AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C sur place d’EHPAD clôturés sans suite"" ,
sans_sanction_sur_pieces,
total_sur_pieces,
ROUND((CAST(sans_sanction_sur_pieces AS FLOAT) / NULLIF(CAST(total_sur_pieces AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C sur pièces d’EHPAD clôturés sans suite"" 
FROM sans_sanction_sur_place
LEFT JOIN total_sur_place
LEFT JOIN sans_sanction_sur_pieces
LEFT JOIN total_sur_pieces"
y8_taux_sanction_statut,"CREATE VIEW y8_taux_sanction_statut AS 
WITH sans_sanction_prive_non_lucratif AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS sans_sanction_prive_non_lucratif
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""sans sanction""
		AND statut_juridique_lb_corr = ""Organisme Privé à But non Lucratif""
)
, total_prive_non_lucratif AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS total_prive_non_lucratif
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		statut_juridique_lb_corr = ""Organisme Privé à But non Lucratif""
)
, sans_sanction_prive_commercial AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS sans_sanction_prive_commercial
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""sans sanction""
		AND statut_juridique_lb_corr = ""Organisme Privé à Caractère Commercial""
)
, total_prive_commercial AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS total_prive_commercial
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		statut_juridique_lb_corr = ""Organisme Privé à Caractère Commercial""
)
, sans_sanction_public AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS sans_sanction_public
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		SANCTION = ""sans sanction""
		AND statut_juridique_lb_corr = ""Organisme public""
)
, total_public AS (
	SELECT
		COUNT(DISTINCT ""Identifiant de la mission"") AS total_public
	FROM 
		DWH_MISSIONS_SANCTION
	WHERE 
		statut_juridique_lb_corr = ""Organisme public""
)
SELECT 
sans_sanction_prive_non_lucratif,
total_prive_non_lucratif,
ROUND((CAST(sans_sanction_prive_non_lucratif AS FLOAT) / NULLIF(CAST(total_prive_non_lucratif AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C (tout type d’I-C confondus) d’EHPAD privés à but non lucratif clôturés sans suite"",
sans_sanction_prive_commercial,
total_prive_commercial,
ROUND((CAST(sans_sanction_prive_commercial AS FLOAT) / NULLIF(CAST(total_prive_commercial AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C (tout type d’I-C confondus) d’EHPAD privés à caractère commercial clôturés sans suite"",
sans_sanction_public,
total_public,
ROUND((CAST(sans_sanction_public AS FLOAT) / NULLIF(CAST(total_public AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C (tout type d’I-C confondus) d’EHPAD public clôturés sans suite ""
FROM sans_sanction_prive_non_lucratif
LEFT JOIN total_prive_non_lucratif
LEFT JOIN sans_sanction_prive_commercial
LEFT JOIN total_prive_commercial
LEFT JOIN sans_sanction_public
LEFT JOIN total_public"
y9_taux_decisions,"CREATE VIEW y9_taux_decisions AS 
WITH 
detail AS (SELECT 
	""Type de décision"" ,
	COUNT(DISTINCT ""Identifiant de la mission"" ) AS ""Nombre de missions d'I-C distinctes avec au moins une décision ou aucune""
FROM 
	DWH_SUITES
GROUP BY  
	""Type de décision""
)
, total AS (
SELECT 
	COUNT(DISTINCT ""Identifiant de la mission"" ) AS ""Total de missions d'I-C distinctes""
FROM 
	DWH_SUITES
--WHERE 
	--""Type de décision"" IS NOT NULL
)
SELECT
	""Type de décision"",
	""Nombre de missions d'I-C distinctes avec au moins une décision ou aucune"",
	""Total de missions d'I-C distinctes"",
	ROUND((CAST(""Nombre de missions d'I-C distinctes avec au moins une décision ou aucune"" AS FLOAT) / NULLIF(CAST(""Total de missions d'I-C distinctes"" AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C (tout type d’I-C confondus) d’EHPAD (tout statut confondu ) réalisés avec au moins une décision édictée ou aucune""
FROM 
	detail
LEFT JOIN total"
y10_taux_decisions_statut,"CREATE VIEW y10_taux_decisions_statut AS 
WITH 
detail AS (SELECT 
	COALESCE(statut_juridique_lb_corr, """") AS statut_juridique_lb_corr ,
	""Type de décision"" ,
	COUNT(DISTINCT ""Identifiant de la mission"" ) AS ""Nombre de missions d'I-C distinctes avec au moins une décision ou aucune""
FROM 
	DWH_SUITES
GROUP BY  
	statut_juridique_lb_corr ,
	""Type de décision""
)
, total AS (
SELECT 
	COALESCE(statut_juridique_lb_corr, """") AS statut_juridique_lb_corr ,
	COUNT(DISTINCT ""Identifiant de la mission"" ) AS ""Total de missions d'I-C distinctes""
FROM 
	DWH_SUITES
GROUP BY
	statut_juridique_lb_corr
--WHERE 
	--""Type de décision"" IS NOT NULL
)
SELECT
	detail.statut_juridique_lb_corr ,
	""Type de décision"",
	""Nombre de missions d'I-C distinctes avec au moins une décision ou aucune"",
	""Total de missions d'I-C distinctes"",
	ROUND((CAST(""Nombre de missions d'I-C distinctes avec au moins une décision ou aucune"" AS FLOAT) / NULLIF(CAST(""Total de missions d'I-C distinctes"" AS FLOAT), 0)) * 100, 2) AS ""Taux d’I-C (tout type d’I-C confondus) d’EHPAD (tout statut confondu ) réalisés avec au moins une décision édictée ou aucune""
FROM 
	detail
LEFT JOIN total ON detail.statut_juridique_lb_corr = total.statut_juridique_lb_corr"
y11_injonctions,"CREATE VIEW y11_injonctions AS
WITH detail AS ( 
-- injonctions par thème, sous-thème et statut juridique
SELECT 
""Thème Décision"" ,
""Sous-thème Décision"" ,
SUM(NB_SUITE) AS ""Injonctions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Injonction""
GROUP BY
""Thème Décision"" ,
""Sous-thème Décision""
)
, total AS (
SELECT
SUM(NB_SUITE) AS ""Total Injonctions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Injonction""
)
SELECT 
""Thème Décision"",
""Sous-thème Décision"",
Injonctions AS ""Nombre d’injonctions afférentes"",
""Total Injonctions"" ,
ROUND((CAST(Injonctions AS FLOAT) / NULLIF(CAST(""Total Injonctions"" AS FLOAT), 0)) * 100, 2) AS ""% global""
FROM detail
LEFT JOIN total"
y12_prescriptions,"CREATE VIEW y12_prescriptions AS
WITH detail AS ( 
-- injonctions par thème, sous-thème et statut juridique
SELECT 
""Thème Décision"" ,
""Sous-thème Décision"" ,
SUM(NB_SUITE) AS ""Prescriptions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Prescription""
GROUP BY
""Thème Décision"" ,
""Sous-thème Décision""
)
, total AS (
SELECT
SUM(NB_SUITE) AS ""Total Prescriptions""
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Prescription""
)
SELECT 
""Thème Décision"",
""Sous-thème Décision"",
Prescriptions AS ""Nombre de prescriptions afférentes"",
""Total Prescriptions"" ,
ROUND((CAST(Prescriptions AS FLOAT) / NULLIF(CAST(""Total Prescriptions"" AS FLOAT), 0)) * 100, 2) AS ""% global""
FROM detail
LEFT JOIN total"
erreurs_finess,"CREATE VIEW erreurs_finess AS 
SELECT 
*
FROM DWH_MISSIONS
WHERE dep_cd = ""NC"""
erreur_sans_finess,"CREATE VIEW erreur_sans_finess AS
SELECT
*
FROM DWH_MISSIONS
WHERE finess_cd = """""
DWH_MISSIONS_AGG_commune,"CREATE VIEW DWH_MISSIONS_AGG_commune AS
-- # SCRIPT des missions agrégées hors santé environnement
-- table lien entre code commune et codes département et région
WITH 
-- table qui compte les EHPAD selon la source FINESS 500 ACTUEL
compte_ehpad AS (
SELECT 
rg.REG_CD || rg.DEP_CD || t_finess_500.com_code as id_ref,
rg.REG_CD as reg_cd,
rg.REG_LB as reg_lb,
rg.DEP_CD as dep_cd,
rg.dep_lb as dep_lb,
t_finess_500.com_code as com_cd,
rg.COM_LB as com_lb,
finess,
rs
FROM TdBICFiness_500_20250207 t_finess_500
LEFT JOIN RefGeo_20250207 rg ON t_finess_500.com_code = rg.COM_CD 
--LEFT JOIN ref_insee_departement ON lien_communes.dep = ref_insee_departement.DEP 
--LEFT JOIN ref_insee_region ON ref_insee_departement.REG = ref_insee_region.reg_cd
)
-- table qui compte les ehpad contrôlés
, compte_ehpad_controles AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
CD_FINESS
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real  
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui compte le nombre de missions
, compte_missions AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
""Identifiant de la mission""
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui recense toutes les combinaisons id_ref possibles
, reference AS (
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad_controles
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_missions)
-- table qui croise les tables de compte_%
, communes AS (
SELECT 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb,
COUNT(DISTINCT finess) AS NB_EHPAD,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION,
COUNT(DISTINCT CD_FINESS) AS NB_ETAB_CONTROLE,
(CAST(COUNT(DISTINCT CD_FINESS) AS FLOAT)/CAST(COUNT(DISTINCT finess) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM reference
LEFT JOIN compte_ehpad ON reference.id_ref = compte_ehpad.id_ref
LEFT JOIN compte_ehpad_controles ON reference.id_ref = compte_ehpad_controles.id_ref
LEFT JOIN compte_missions ON reference.id_ref = compte_missions.id_ref
GROUP BY 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb
)
-- table au niveau département
, departements AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb
)
-- table au niveau régional
, regions AS (
SELECT 
reg_cd,
reg_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb
)
SELECT 
*
FROM communes"
DWH_MISSIONS_AGG_departement,"CREATE VIEW DWH_MISSIONS_AGG_departement AS 
-- # SCRIPT des missions agrégées hors santé environnement
-- table lien entre code commune et codes département et région
WITH 
-- table qui compte les EHPAD selon la source FINESS 500 ACTUEL
compte_ehpad AS (
SELECT 
rg.REG_CD || rg.DEP_CD || t_finess_500.com_code as id_ref,
rg.REG_CD as reg_cd,
rg.REG_LB as reg_lb,
rg.DEP_CD as dep_cd,
rg.dep_lb as dep_lb,
t_finess_500.com_code as com_cd,
rg.COM_LB as com_lb,
finess,
rs
FROM TdBICFiness_500_20250207 t_finess_500
LEFT JOIN RefGeo_20250207 rg ON t_finess_500.com_code = rg.COM_CD 
--LEFT JOIN ref_insee_departement ON lien_communes.dep = ref_insee_departement.DEP 
--LEFT JOIN ref_insee_region ON ref_insee_departement.REG = ref_insee_region.reg_cd
)
-- table qui compte les ehpad contrôlés
, compte_ehpad_controles AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
CD_FINESS
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real  
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui compte le nombre de missions
, compte_missions AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
""Identifiant de la mission""
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui recense toutes les combinaisons id_ref possibles
, reference AS (
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad_controles
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_missions)
-- table qui croise les tables de compte_%
, communes AS (
SELECT 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb,
COUNT(DISTINCT finess) AS NB_EHPAD,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION,
COUNT(DISTINCT CD_FINESS) AS NB_ETAB_CONTROLE,
(CAST(COUNT(DISTINCT CD_FINESS) AS FLOAT)/CAST(COUNT(DISTINCT finess) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM reference
LEFT JOIN compte_ehpad ON reference.id_ref = compte_ehpad.id_ref
LEFT JOIN compte_ehpad_controles ON reference.id_ref = compte_ehpad_controles.id_ref
LEFT JOIN compte_missions ON reference.id_ref = compte_missions.id_ref
GROUP BY 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb
)
-- table au niveau département
, departements AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb
)
-- table au niveau régional
, regions AS (
SELECT 
reg_cd,
reg_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb
)
SELECT 
*
FROM departements"
DWH_MISSIONS_AGG_region,"CREATE VIEW DWH_MISSIONS_AGG_region AS 
-- # SCRIPT des missions agrégées hors santé environnement
-- table lien entre code commune et codes département et région
WITH 
-- table qui compte les EHPAD selon la source FINESS 500 ACTUEL
compte_ehpad AS (
SELECT 
rg.REG_CD || rg.DEP_CD || t_finess_500.com_code as id_ref,
rg.REG_CD as reg_cd,
rg.REG_LB as reg_lb,
rg.DEP_CD as dep_cd,
rg.dep_lb as dep_lb,
t_finess_500.com_code as com_cd,
rg.COM_LB as com_lb,
finess,
rs
FROM TdBICFiness_500_20250207 t_finess_500
LEFT JOIN RefGeo_20250207 rg ON t_finess_500.com_code = rg.COM_CD 
--LEFT JOIN ref_insee_departement ON lien_communes.dep = ref_insee_departement.DEP 
--LEFT JOIN ref_insee_region ON ref_insee_departement.REG = ref_insee_region.reg_cd
)
-- table qui compte les ehpad contrôlés
, compte_ehpad_controles AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
CD_FINESS
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real  
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui compte le nombre de missions
, compte_missions AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
""Identifiant de la mission""
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui recense toutes les combinaisons id_ref possibles
, reference AS (
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad_controles
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_missions)
-- table qui croise les tables de compte_%
, communes AS (
SELECT 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb,
COUNT(DISTINCT finess) AS NB_EHPAD,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION,
COUNT(DISTINCT CD_FINESS) AS NB_ETAB_CONTROLE,
(CAST(COUNT(DISTINCT CD_FINESS) AS FLOAT)/CAST(COUNT(DISTINCT finess) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM reference
LEFT JOIN compte_ehpad ON reference.id_ref = compte_ehpad.id_ref
LEFT JOIN compte_ehpad_controles ON reference.id_ref = compte_ehpad_controles.id_ref
LEFT JOIN compte_missions ON reference.id_ref = compte_missions.id_ref
GROUP BY 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb
)
-- table au niveau département
, departements AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb
)
-- table au niveau régional
, regions AS (
SELECT 
reg_cd,
reg_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb
)
SELECT 
*
FROM regions"
y1_national,"CREATE VIEW y1_national AS 
-- # SCRIPT des missions agrégées hors santé environnement
-- table lien entre code commune et codes département et région
WITH 
-- table qui compte les EHPAD selon la source FINESS 500 ACTUEL
compte_ehpad AS (
SELECT 
rg.REG_CD || rg.DEP_CD || t_finess_500.com_code as id_ref,
rg.REG_CD as reg_cd,
rg.REG_LB as reg_lb,
rg.DEP_CD as dep_cd,
rg.dep_lb as dep_lb,
t_finess_500.com_code as com_cd,
rg.COM_LB as com_lb,
finess,
rs
FROM TdBICFiness_500_20250207 t_finess_500
LEFT JOIN RefGeo_20250207 rg ON t_finess_500.com_code = rg.COM_CD 
--LEFT JOIN ref_insee_departement ON lien_communes.dep = ref_insee_departement.DEP 
--LEFT JOIN ref_insee_region ON ref_insee_departement.REG = ref_insee_region.reg_cd
)
-- table qui compte les ehpad contrôlés
, compte_ehpad_controles AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
CD_FINESS
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real  
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui compte le nombre de missions
, compte_missions AS (
SELECT 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN rr.REG
		WHEN rg.REG_CD IS NULL THEN ""NC""
		ELSE rg.REG_CD
	END || 
	CASE
		WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
		WHEN rg.DEP_LB IS NULL THEN ""NC""
		ELSE rg.DEP_CD
	END || 
	IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code)
as id_ref,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.REG
	WHEN rg.REG_CD IS NULL THEN ""NC""
	ELSE rg.REG_CD
END
as reg_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rr.LIBELLE
	WHEN rg.REG_LB IS NULL THEN ""NC""
	ELSE rg.REG_LB
END
as reg_lb,
CASE
	WHEN missions_real.CD_FINESS = """" THEN IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")
	WHEN rg.DEP_LB IS NULL THEN ""NC""
	ELSE rg.DEP_CD
END
as dep_cd,
CASE
	WHEN missions_real.CD_FINESS = """" THEN rd.LIBELLE
	WHEN rg.dep_lb IS NULL THEN ""NC""
	ELSE rg.dep_lb
END
as dep_lb,
IIF(t_finess.com_code IS NULL, ""NC"", t_finess.com_code) as com_cd,
IIF(rg.COM_CD  IS NULL, ""NC"", rg.COM_LB) as com_lb,
""Identifiant de la mission""
--FROM ODS_IC
FROM TdBICSiiceaMissionsReal_20250210 missions_real
LEFT JOIN TdBICFiness_500_20250207 t_finess ON missions_real.CD_FINESS = t_finess.finess
LEFT JOIN RefGeo_20250207 rg ON t_finess.com_code = rg.COM_CD 
LEFT JOIN RefDepartements_20250207 rd ON (IIF(LENGTH(missions_real.""Département"")=1, ""0"" || missions_real.""Département"", missions_real.""Département"")) = rd.DEP 
LEFT JOIN RefRegions_20250207 rr ON rd.REG = rr.REG)
-- table qui recense toutes les combinaisons id_ref possibles
, reference AS (
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_ehpad_controles
UNION 
SELECT 
id_ref,
reg_cd,
reg_lb,
dep_cd,
dep_lb,
com_cd,
com_lb
FROM compte_missions)
-- table qui croise les tables de compte_%
, communes AS (
SELECT 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb,
COUNT(DISTINCT finess) AS NB_EHPAD,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSION,
COUNT(DISTINCT CD_FINESS) AS NB_ETAB_CONTROLE,
(CAST(COUNT(DISTINCT CD_FINESS) AS FLOAT)/CAST(COUNT(DISTINCT finess) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM reference
LEFT JOIN compte_ehpad ON reference.id_ref = compte_ehpad.id_ref
LEFT JOIN compte_ehpad_controles ON reference.id_ref = compte_ehpad_controles.id_ref
LEFT JOIN compte_missions ON reference.id_ref = compte_missions.id_ref
GROUP BY 
reference.id_ref,
reference.reg_cd,
reference.reg_lb,
reference.dep_cd,
reference.dep_lb,
reference.com_cd,
reference.com_lb
)
-- table au niveau département
, departements AS (
SELECT 
reg_cd,
reg_lb,
dep_cd,
dep_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb,
dep_cd,
dep_lb
)
-- table au niveau régional
, regions AS (
SELECT 
reg_cd,
reg_lb,
SUM(NB_EHPAD) AS NB_EHPAD,
SUM(NB_MISSION) AS NB_MISSION,
SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS NB_ETAB_CONTROLE_NB_EHPAD
FROM communes
GROUP BY 
reg_cd,
reg_lb
)
, nat AS (
SELECT 
	SUM(NB_EHPAD) AS NB_EHPAD,
	SUM(NB_MISSION) AS NB_MISSION,
	SUM(NB_ETAB_CONTROLE) AS NB_ETAB_CONTROLE,
	(CAST(SUM(NB_ETAB_CONTROLE) AS FLOAT)/CAST(SUM(NB_EHPAD) AS FLOAT))*100 AS ""Taux d’EHPAD différents inspectés au moins une fois""
FROM communes
)
SELECT 
*
FROM nat"
y4_moyennes_suites,"CREATE VIEW y4_moyennes_suites AS
WITH 
Reference AS (  
SELECT
	DISTINCT (COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """")) AS ref,
	""Identifiant de la mission"",
	statut_juridique_cd,
	statut_juridique_lb_corr
FROM 
	DWH_SUITES
)
, Injonction AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        statut_juridique_cd,
        statut_juridique_lb_corr,
        SUM(NB_SUITE) AS Injonction
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN ('Injonction')
    GROUP BY 
    	""Identifiant de la mission"", 
        statut_juridique_cd,
    	statut_juridique_lb_corr
)
, Prescription AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        statut_juridique_cd,
        statut_juridique_lb_corr,
        SUM(NB_SUITE) AS Prescription
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN ('Prescription')
    GROUP BY 
    	""Identifiant de la mission"", 
        statut_juridique_cd,
    	statut_juridique_lb_corr
)
, Coercitif AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        statut_juridique_cd,
        statut_juridique_lb_corr,
        SUM(NB_SUITE) AS Coercitif
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN (
    		'Injonction',
    		'Prescription')
    GROUP BY 
    	""Identifiant de la mission"", 
        statut_juridique_cd,
    	statut_juridique_lb_corr
)
, Recommandation AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        statut_juridique_cd,
        statut_juridique_lb_corr,
        SUM(NB_SUITE) AS Recommandation
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN ('Recommandation')
    GROUP BY 
    	""Identifiant de la mission"", 
        statut_juridique_cd,
    	statut_juridique_lb_corr
)
, raw AS (
SELECT
	Reference.""ref"",
	Reference.""Identifiant de la mission"",	
	Reference.statut_juridique_cd,	
	Reference.statut_juridique_lb_corr,
	Injonction.Injonction,
	Prescription.Prescription,
	Coercitif.Coercitif,
	Recommandation.Recommandation
FROM 
	Reference
LEFT JOIN 
	Injonction ON Reference.ref = Injonction.ref
LEFT JOIN 
	Prescription ON Reference.ref = Prescription.ref
LEFT JOIN 
	Coercitif ON Reference.ref = Coercitif.ref
LEFT JOIN 
	Recommandation ON Reference.ref = Recommandation.ref
)
SELECT 
	statut_juridique_lb_corr,
	COUNT(DISTINCT ""Identifiant de la mission"") AS ""Nombre total de missions d'I-C""
	,SUM(Injonction) AS ""Nombre total d'injonctions""
	,ROUND((CAST(SUM(Injonction) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen d'injonctions par mission d'I-C""
	,SUM(Prescription) AS ""Nombre total de prescriptions""
	,ROUND((CAST(SUM(Prescription) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen de prescriptions par mission d'I-C""
	,SUM(Coercitif) AS ""Nombre total de suites coercitives""
	,ROUND((CAST(SUM(Coercitif) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen de suites coercitives par mission d'I-C""
	,SUM(Recommandation) AS ""Nombre total de recommandations""
	,ROUND((CAST(SUM(Recommandation) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen de recommandations par mission d'I-C""
FROM 	
	raw
GROUP BY 
	statut_juridique_lb_corr"
y5_moyennes_toutes_suites,"CREATE VIEW y5_moyennes_toutes_suites AS
WITH 
Reference AS (  
SELECT
	DISTINCT (COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """")) AS ref,
	""Identifiant de la mission""
FROM 
	DWH_SUITES
)
, Injonction AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        SUM(NB_SUITE) AS Injonction
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN ('Injonction')
    GROUP BY 
    	""Identifiant de la mission""
)
, Prescription AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        SUM(NB_SUITE) AS Prescription
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN ('Prescription')
    GROUP BY 
    	""Identifiant de la mission""
)
, Coercitif AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        SUM(NB_SUITE) AS Coercitif
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN (
    		'Injonction',
    		'Prescription')
    GROUP BY 
    	""Identifiant de la mission""
)
, Recommandation AS (
    SELECT 
    	COALESCE(""Identifiant de la mission"", """") || COALESCE(statut_juridique_cd, """") AS ref,
        ""Identifiant de la mission"",
        SUM(NB_SUITE) AS Recommandation
    FROM 
    	DWH_SUITES
    WHERE 
    	""Type de décision"" IN ('Recommandation')
    GROUP BY 
    	""Identifiant de la mission""
)
, raw AS (
SELECT
	Reference.""ref"",
	Reference.""Identifiant de la mission"",	
	Injonction.Injonction,
	Prescription.Prescription,
	Coercitif.Coercitif,
	Recommandation.Recommandation
FROM 
	Reference
LEFT JOIN 
	Injonction ON Reference.ref = Injonction.ref
LEFT JOIN 
	Prescription ON Reference.ref = Prescription.ref
LEFT JOIN 
	Coercitif ON Reference.ref = Coercitif.ref
LEFT JOIN 
	Recommandation ON Reference.ref = Recommandation.ref
)
SELECT 
	COUNT(DISTINCT ""Identifiant de la mission"") AS ""Nombre total de missions d'I-C""
	,SUM(Injonction) AS ""Nombre total d'injonctions""
	,ROUND((CAST(SUM(Injonction) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen d'injonctions par mission d'I-C""
	,SUM(Prescription) AS ""Nombre total de prescriptions""
	,ROUND((CAST(SUM(Prescription) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen de prescriptions par mission d'I-C""
	,SUM(Coercitif) AS ""Nombre total de suites coercitives""
	,ROUND((CAST(SUM(Coercitif) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen de suites coercitives par mission d'I-C""
	,SUM(Recommandation) AS ""Nombre total de recommandations""
	,ROUND((CAST(SUM(Recommandation) AS FLOAT) / NULLIF(CAST(COUNT(DISTINCT ""Identifiant de la mission"") AS FLOAT), 0)), 2) AS ""Nombre moyen de recommandations par mission d'I-C""
FROM 	
	raw"
y13_taux_decisions,"CREATE VIEW y13_taux_decisions AS
WITH 
total AS (SELECT
COALESCE(DWH_MISSIONS_SANCTION.reg_cd, """") AS reg_cd
, DWH_MISSIONS_SANCTION.reg_lb
, COUNT( DISTINCT DWH_MISSIONS_SANCTION.""Identifiant de la mission"" ) AS total
FROM DWH_MISSIONS_SANCTION
GROUP BY DWH_MISSIONS_SANCTION.reg_cd)
, avec AS (
SELECT
COALESCE(DWH_MISSIONS_SANCTION.reg_cd, """") AS reg_cd
, DWH_MISSIONS_SANCTION.reg_lb
, COUNT( DISTINCT DWH_MISSIONS_SANCTION.""Identifiant de la mission"" ) AS avec
FROM DWH_MISSIONS_SANCTION
WHERE DWH_MISSIONS_SANCTION.SANCTION = ""avec sanction""
GROUP BY DWH_MISSIONS_SANCTION.reg_cd )
, sans AS (
SELECT
COALESCE(DWH_MISSIONS_SANCTION.reg_cd, """") AS reg_cd
, DWH_MISSIONS_SANCTION.reg_lb
, COUNT( DISTINCT DWH_MISSIONS_SANCTION.""Identifiant de la mission"" ) AS sans
FROM DWH_MISSIONS_SANCTION
WHERE DWH_MISSIONS_SANCTION.SANCTION = ""sans sanction""
GROUP BY DWH_MISSIONS_SANCTION.reg_cd)
SELECT
total.reg_cd
, total.reg_lb
, total.total
, avec.avec
, ROUND((CAST(avec.avec AS FLOAT) / NULLIF(CAST(total.total AS FLOAT), 0)) * 100, 2) AS ""Taux de missions d'I-C clôturées avec suite""
, sans.sans
, ROUND((CAST(sans.sans AS FLOAT) / NULLIF(CAST(total.total AS FLOAT), 0)) * 100, 2)AS ""Taux de missions d'I-C clôturées sans suite""
FROM total 
LEFT JOIN avec ON total.reg_cd = avec.reg_cd
left join sans ON total.reg_cd = sans.reg_cd"
TDB_SANCTION_STATUT_JURIDIQUE,"CREATE VIEW TDB_SANCTION_STATUT_JURIDIQUE AS
-- 4 431 I-C d'EHPAD réalisées
WITH missions_real AS (
SELECT 
COALESCE(reg_lb, """") || COALESCE(statut_juridique_lb, """") AS ID_REF ,
reg_lb ,
statut_juridique_lb ,
SUM(NB_MISSION) AS NB_MISSIONS_REAL
FROM DWH_MISSIONS
--WHERE filtre = ""Hors santé-environnement""
GROUP BY 
reg_lb ,
statut_juridique_lb 
ORDER BY 
reg_lb ASC,
statut_juridique_lb ASC
)
, missions_clo_ss_s AS (
-- Nombre d'I-C clôturées sans suites coercitives (injonction, prescription) ni saisine
SELECT 
COALESCE(reg_lb, """") || COALESCE(statut_juridique_lb, """") AS ID_REF ,
reg_lb ,
statut_juridique_lb ,
COUNT(DISTINCT ""Identifiant de la mission"") AS NB_MISSIONS_CLOTUREES_SANS_S
FROM DWH_MISSIONS_SANCTION
--WHERE filtre = ""Hors santé-environnement"" 
WHERE SANCTION = ""sans sanction""
GROUP BY
reg_lb ,
statut_juridique_lb 
ORDER BY 
reg_lb ASC,
statut_juridique_lb ASC
)
, injonctions AS (
-- nombre d'injonctions
SELECT 
COALESCE(reg_lb, """") || COALESCE(statut_juridique_lb, """") AS ID_REF ,
reg_lb ,
statut_juridique_lb ,
SUM(NB_SUITE) AS NB_INJONCTIONS
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Injonction""
GROUP BY
reg_lb ,
statut_juridique_lb 
ORDER BY 
reg_lb ASC,
statut_juridique_lb ASC
)
, prescriptions AS (
-- nombre de prescriptions
SELECT 
COALESCE(reg_lb, """") || COALESCE(statut_juridique_lb, """") AS ID_REF ,
reg_lb ,
statut_juridique_lb ,
SUM(NB_SUITE) AS NB_PRESCRIPTIONS
FROM DWH_SUITES
--WHERE filtre = ""Hors santé-environnement"" 
WHERE ""Type de décision"" = ""Prescription""
GROUP BY
reg_lb ,
statut_juridique_lb 
ORDER BY 
reg_lb ASC,
statut_juridique_lb ASC
)
, reference AS (
		SELECT 
			ID_REF
			, reg_lb
			, statut_juridique_lb
		FROM missions_real
UNION 	SELECT 
			ID_REF
			, reg_lb
			, statut_juridique_lb 
		FROM missions_clo_ss_s
UNION 	SELECT 
			ID_REF
			, reg_lb
			, statut_juridique_lb 
		FROM injonctions
UNION 	SELECT 
			ID_REF
			, reg_lb
			, statut_juridique_lb 
		FROM prescriptions
)
, cross_all AS (
SELECT 
reference.reg_lb AS ""Région"",
reference.statut_juridique_lb AS ""Statut juridique"",
NB_MISSIONS_REAL AS ""I-C d'EHPAD réalisées"",
NB_MISSIONS_CLOTUREES_SANS_S AS ""Nombre d'I-C clôturées sans suites coercitives (injonction, prescription) ni saisine"",
NB_INJONCTIONS AS ""Total injonctions"",
CAST(NB_INJONCTIONS AS FLOAT) / CAST(NB_MISSIONS_REAL AS FLOAT) AS ""Nombre moyen d'injonctions / I-C réalisé"",
NB_PRESCRIPTIONS AS ""Total prescriptions"",
IFNULL(NB_PRESCRIPTIONS,0) / IFNULL(NB_MISSIONS_REAL,0) AS ""Nombre moyen de prescriptions / I-C réalisé"",
CAST(NB_INJONCTIONS AS FLOAT) + CAST(NB_PRESCRIPTIONS AS FLOAT) AS ""Total injonctions et prescriptions"",
CAST((NB_INJONCTIONS + NB_PRESCRIPTIONS) AS FLOAT) / CAST(NB_MISSIONS_REAL AS FLOAT) AS ""Nombre moyen d'injonctions et de prescriptions / I-C réalisé"",
(CAST(NB_INJONCTIONS AS FLOAT) / CAST((NB_INJONCTIONS + NB_PRESCRIPTIONS) AS FLOAT))*100 AS ""Part injonctions (en %)"",
(CAST(NB_PRESCRIPTIONS AS FLOAT) / CAST((NB_INJONCTIONS + NB_PRESCRIPTIONS) AS FLOAT))*100 AS ""Part prescriptions (en %)""
FROM reference
LEFT JOIN missions_real ON reference.ID_REF = missions_real.ID_REF
LEFT JOIN missions_clo_ss_s ON reference.ID_REF = missions_clo_ss_s.ID_REF
LEFT JOIN injonctions ON reference.ID_REF = injonctions.ID_REF
LEFT JOIN prescriptions ON reference.ID_REF = prescriptions.ID_REF
)
SELECT 
*
FROM cross_all"
